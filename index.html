<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Int√©rpreprete Fisiol√≥gico</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
        
    <!-- pdf.js para leer PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;</script>
    
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D0C1D;
            background-image: radial-gradient(circle at top left, rgba(79, 70, 229, 0.2), transparent 30%),
                              radial-gradient(circle at bottom right, rgba(168, 85, 247, 0.2), transparent 30%);
            color: #E0E0E0;
        }
        .brand-gradient-text {
            background: linear-gradient(90deg, #4F46E5, #A855F7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .brand-gradient-bg {
            background: linear-gradient(90deg, #4F46E5, #A855F7);
        }
        .master-gradient-bg {
            background: linear-gradient(90deg, #F97316, #EF4444); /* Orange-500 to Red-500 */
        }
        .screen {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
        }
        .card {
            background-color: #16152B;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.15);
            border-color: rgba(168, 85, 247, 0.4);
        }
        .custom-input {
            background-color: #0D0C1D;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 0.75rem;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .custom-input:focus {
            border-color: #4F46E5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4F46E5;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-md mx-auto">

        <!-- Pantalla de Bienvenida -->
        <div id="welcome-screen" class="screen text-center space-y-8">
             <div class="flex justify-center">
                <div class="relative w-48 h-48 rounded-full p-1.5 bg-gradient-to-br from-indigo-500 to-fuchsia-500 shadow-2xl shadow-purple-500/30 flex items-center justify-center">
                    <div class="bg-[#0D0C1D] w-full h-full rounded-full p-1.5">
                         <img src="https://i.ibb.co/20NypXdZ/ketoorigins.png" alt="Logo" class="w-full h-full rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/180x180/0D0C1D/FFFFFF?text=Logo';">
                    </div>
                </div>
            </div>
            <h1 class="text-3xl font-bold tracking-tight">üß¨ Tu Int√©rprete <span class="brand-gradient-text">Fisiol√≥gico</span></h1>
            <div class="card p-6 text-left text-sm space-y-4">
                <h2 class="font-semibold text-lg text-center">ü§ù Nuestro Pacto</h2>
                <p class="text-gray-400">Esta herramienta es <strong class="text-white">educativa</strong>. No ofrece diagn√≥sticos ni reemplaza a tu m√©dico.</p>
                <p class="text-gray-400">Su prop√≥sito es darte contexto sobre tus biomarcadores y ayudarte a formular <strong class="text-white">preguntas inteligentes</strong> para tu pr√≥xima consulta.</p>
            </div>
            <button id="accept-pact-btn" class="w-full brand-gradient-bg text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-indigo-500/40 hover:scale-105 transform transition-transform duration-300">
                Entendido, empezar ahora
            </button>
        </div>

        <!-- Pantalla de Perfil de Usuario -->
        <div id="profile-screen" class="screen hidden card p-8 space-y-6">
            <h2 class="text-2xl font-bold text-center">üë§ Crea tu Perfil</h2>
            <p class="text-center text-gray-400 text-sm">Estos datos son cruciales para una interpretaci√≥n contextualizada.</p>
            <form id="profile-form" class="space-y-4">
                 <div>
                    <label for="name" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label>
                    <input type="text" id="name" required class="w-full custom-input" placeholder="Ej: Juan P√©rez">
                </div>
                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-300 mb-1">Fecha de Nacimiento</label>
                    <input type="date" id="dob" required class="w-full custom-input">
                </div>
                <div>
                    <label for="sex" class="block text-sm font-medium text-gray-300 mb-1">Sexo Biol√≥gico</label>
                    <select id="sex" required class="w-full custom-input">
                        <option value="">Seleccionar...</option>
                        <option value="male">‚ôÇÔ∏è Masculino</option>
                        <option value="female">‚ôÄÔ∏è Femenino</option>
                    </select>
                </div>
                <div>
                    <label for="diet" class="block text-sm font-medium text-gray-300 mb-1">Enfoque Nutricional</label>
                    <select id="diet" required class="w-full custom-input">
                        <option value="keto">ü•ë Bajo en Carbohidratos / Keto</option>
                        <option value="standard">üçî Est√°ndar / Occidental</option>
                        <option value="low-fat">ü•ó Baja en Grasa</option>
                        <option value="vegan">üå± Basada en Plantas</option>
                        <option value="other">‚ùì Otro</option>
                    </select>
                </div>
                <button type="submit" class="w-full brand-gradient-bg text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-indigo-500/40 hover:scale-105 transform transition-transform duration-300 mt-4">
                    Guardar Perfil
                </button>
            </form>
        </div>

        <!-- Panel Principal (Dashboard) -->
        <div id="dashboard-screen" class="screen hidden space-y-6">
            <div class="text-center">
                <h2 class="text-3xl font-bold">üöÄ Panel Principal</h2>
                <p id="welcome-user" class="text-gray-400"></p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                 <button id="add-exam-file-btn" class="w-full brand-gradient-bg text-white font-bold p-4 rounded-2xl shadow-lg shadow-indigo-500/40 flex flex-col items-center justify-center text-center hover:scale-105 transform transition-transform duration-300 space-y-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                    <span class="text-sm font-semibold">Subir Archivo</span>
                </button>
                <button id="scan-document-btn" class="w-full brand-gradient-bg text-white font-bold p-4 rounded-2xl shadow-lg shadow-indigo-500/40 flex flex-col items-center justify-center text-center hover:scale-105 transform transition-transform duration-300 space-y-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12V6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/><path d="M14.5 10a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Z"/><path d="M12 12h.01"/><path d="M18 20a2 2 0 0 0-2-2h-8a2 2 0 0 0-2 2"/><path d="M6 12v2a2 2 0 0 0 2 2h2"/></svg>
                    <span class="text-sm font-semibold">Escanear Doc.</span>
                </button>
            </div>

            <input type="file" id="file-input" class="hidden" accept="image/*,application/pdf">
            <input type="file" id="scan-input" class="hidden" accept="image/*" capture="environment">

            <button id="add-exam-manual-btn" class="w-full bg-white/5 text-white font-bold py-3 px-6 rounded-xl flex items-center justify-center space-x-3 hover:bg-white/10 transition-colors">
                <span>‚úçÔ∏è Ingresar Datos Manualmente</span>
            </button>

            <div class="card p-6">
                <h3 class="font-bold text-lg mb-3">‚ùì Mis Preguntas para el M√©dico</h3>
                <div id="questions-list" class="space-y-2 text-sm text-gray-300">
                    <p class="text-gray-500">A√∫n no has generado preguntas. Aparecer√°n aqu√≠ despu√©s de tu primer an√°lisis.</p>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="font-bold text-lg mb-2">üî¨ Enfoque de la Semana</h3>
                <p class="text-sm text-gray-400">
                    <strong class="text-white">El Ratio Triglic√©ridos/HDL:</strong> Este no es un marcador que suelen darte en el laboratorio, pero es uno de los indicadores m√°s potentes de resistencia a la insulina y salud metab√≥lica. Un ratio por debajo de 1.5 es considerado √≥ptimo. ¬øC√≥mo est√° el tuyo?
                </p>
            </div>
        </div>
        
        <!-- Pantalla de Ingreso Manual -->
        <div id="manual-entry-screen" class="screen hidden card p-8 space-y-6">
            <h2 class="text-2xl font-bold text-center">‚úçÔ∏è Ingreso Manual de Datos</h2>
            <p class="text-center text-gray-400 text-sm">Introduce los valores de tu examen. Si subiste un archivo, revisa que los datos extra√≠dos sean correctos.</p>
            <form id="manual-form" class="space-y-4"></form>
            <button id="back-to-dashboard-from-manual-btn" class="w-full bg-white/5 text-white font-bold py-3 px-6 rounded-xl hover:bg-white/10 transition-colors mt-2">
                Volver al Panel
            </button>
        </div>

        <!-- Pantalla de Reporte -->
        <div id="report-screen" class="screen hidden space-y-6">
            <h2 class="text-3xl font-bold text-center">üìä Tu Reporte Fisiol√≥gico</h2>
            <div id="report-content" class="space-y-4"></div>
             <div class="space-y-4">
                <button id="master-advice-btn" class="w-full master-gradient-bg text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-red-500/40 hover:scale-105 transform transition-transform duration-300">
                    üéì Recibir Consejo Profesional
                </button>
                <button id="follow-up-btn" class="w-full brand-gradient-bg text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-indigo-500/40 hover:scale-105 transform transition-transform duration-300">
                    Hacer una Pregunta de Seguimiento
                </button>
                <div class="flex space-x-2">
                    <button id="download-pdf-btn" class="w-full bg-white/10 text-white font-bold py-2 px-4 rounded-xl hover:bg-white/20 transition-colors text-sm">
                        Descargar PDF
                    </button>
                    <button id="back-to-dashboard-from-report-btn" class="w-full bg-white/5 text-white font-bold py-2 px-4 rounded-xl hover:bg-white/10 transition-colors text-sm">
                        Volver al Panel
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Personalizado para Notificaciones y Carga -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="card p-8 max-w-sm w-full text-center space-y-4 shadow-2xl shadow-purple-500/20">
            <div id="modal-loader" class="hidden mx-auto loader"></div>
            <h3 id="modal-title" class="text-xl font-bold"></h3>
            <p id="modal-message" class="text-gray-400"></p>
            <div id="modal-buttons" class="flex w-full space-x-2 mt-4">
                <button id="modal-close-btn" class="w-full brand-gradient-bg text-white font-bold py-2 px-8 rounded-lg">Cerrar</button>
                <button id="modal-download-btn" class="hidden w-1/2 master-gradient-bg text-white font-bold py-2 px-8 rounded-lg">Descargar PDF</button>
            </div>
        </div>
    </div>

    <!-- Modal para Pregunta de Seguimiento -->
    <div id="follow-up-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="card p-8 max-w-sm w-full text-center space-y-4 shadow-2xl shadow-purple-500/20">
            <h3 id="follow-up-modal-title" class="text-xl font-bold">Haz una pregunta sobre tu reporte</h3>
            <textarea id="follow-up-input" class="w-full custom-input h-24 text-sm" placeholder="Ej: ¬øQu√© significa 'estenosis foraminal'?"></textarea>
            <div class="flex space-x-2">
                <button id="follow-up-cancel-btn" class="w-full bg-white/5 text-white font-bold py-2 px-8 rounded-lg">Cancelar</button>
                <button id="follow-up-submit-btn" class="w-full brand-gradient-bg text-white font-bold py-2 px-8 rounded-lg">Enviar</button>
            </div>
        </div>
    </div>


    <script>
        // CONSTANTE DE HIDRATACI√ìN
        const HYDRATION_ADVICE = 'Recuerda que la verdadera hidrataci√≥n celular se logra con agua mineral o filtrada, a la que puedes a√±adir una pizca de sal de mar y unas gotas de lim√≥n para reponer electrolitos y mantener la homeostasis h√≠drica.';

        // BASE DE DATOS CENTRAL DE BIOMARCADORES
        const BIOMARKERS_DB = {
             // Orina Completa (PRIORITIZED)
            urinalysisColor: {
                label: 'Color Orina', unit: '', keywords: ['color'], type: 'text',
                interpret: (v) => {
                    v = v.toLowerCase();
                    if (v.includes('amarillo')) return { conventional: '', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Un color amarillo claro a p√°lido es normal e indica una buena hidrataci√≥n. Un amarillo m√°s oscuro sugiere que necesitas beber m√°s agua.', advice: `¬°Buena se√±al! Un color normal indica que est√°s bien hidratado. Consejo: Sigue bebiendo suficiente agua durante el d√≠a. ${HYDRATION_ADVICE}` };
                    return { conventional: '', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: `Un color inusual (${v}) puede deberse a alimentos, medicamentos o condiciones m√©dicas que deben ser evaluadas.`, advice: 'Un color inusual puede ser temporal (por ejemplo, por comer betarraga), pero si persiste sin causa aparente, cons√∫ltalo con tu m√©dico.' };
                }
            },
            urinalysisAspect: {
                label: 'Aspecto Orina', unit: '', keywords: ['aspecto'], type: 'text',
                interpret: (v) => {
                    v = v.toLowerCase();
                    if (v.includes('transparente') || v.includes('claro')) return { conventional: '', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Una orina clara y transparente es normal. Indica que no hay un exceso de c√©lulas, cristales o moco.', advice: `¬°Perfecto! Una orina transparente es se√±al de un tracto urinario saludable. Consejo: Mantener una buena hidrataci√≥n es la mejor forma de asegurar que tu orina se mantenga as√≠. ${HYDRATION_ADVICE}` };
                    return { conventional: '', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: `Un aspecto turbio puede ser un signo de infecci√≥n (por la presencia de bacterias y gl√≥bulos blancos), cristales o moco.`, advice: `La turbidez suele indicar la presencia de bacterias y c√©lulas de defensa. Consejo: Bebe m√°s agua para ayudar a limpiar el sistema y consulta a tu m√©dico, ya que es un signo com√∫n de infecci√≥n urinaria. ${HYDRATION_ADVICE}` };
                }
            },
            urinalysisReaction: {
                label: 'Reacci√≥n Orina', unit: '', keywords: ['reaccion'], type: 'text',
                interpret: (v) => {
                    v = v.toLowerCase();
                    if (v.includes('acida')) return { conventional: '', tag: { text: '√ÅCIDA', color: 'bg-yellow-500' }, physiological: 'Una reacci√≥n √°cida es com√∫n y a menudo est√° relacionada con la dieta (alta en prote√≠nas) o el estado metab√≥lico. Corresponde a un pH bajo.', advice: 'Una reacci√≥n √°cida es com√∫n, sobre todo con dietas altas en prote√≠na. Consejo: Para equilibrar, puedes incorporar m√°s vegetales y frutas a tu dieta. Si sufres de c√°lculos renales, este dato es importante para tu m√©dico.' };
                    if (v.includes('alcalina')) return { conventional: '', tag: { text: 'ALCALINA', color: 'bg-yellow-500' }, physiological: 'Una reacci√≥n alcalina puede estar relacionada con una dieta vegetariana o ciertas infecciones. Corresponde a un pH alto.', advice: 'Una reacci√≥n alcalina puede deberse a una dieta rica en vegetales o a ciertas infecciones. Consejo: Si no sigues una dieta vegetariana, com√©ntale este resultado a tu m√©dico, ya que algunas bacterias alcalinizan la orina.' };
                    return { conventional: '', tag: { text: 'INFO', color: 'bg-gray-500' }, physiological: `El resultado es ${v}.`, advice: 'Este es un dato informativo que complementa al pH. Habla con tu m√©dico si tienes dudas.' };
                }
            },
            urinalysisDensity: {
                label: 'Densidad Urinaria', unit: '', keywords: ['densidad'], type: 'numeric',
                interpret: (v) => {
                    if(v > 10000) v = v / 1000000;
                    if(v > 100) v = v / 1000; 
                    if (v >= 1.005 && v <= 1.030) return { conventional: 'Rango: 1.005 - 1.030', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tu densidad urinaria es normal, lo que indica un buen estado de hidrataci√≥n y que tus ri√±ones est√°n concentrando la orina adecuadamente.', advice: `¬°Buen equilibrio! Una densidad normal muestra que tus ri√±ones tienen la flexibilidad para concentrar o diluir la orina seg√∫n las necesidades de tu cuerpo. Consejo: Sigue manteniendo un buen nivel de hidrataci√≥n. ${HYDRATION_ADVICE}` };
                    if (v < 1.005) return { conventional: 'Rango: 1.005 - 1.030', tag: { text: 'BAJA', color: 'bg-yellow-500' }, physiological: 'Una densidad baja significa que la orina est√° muy diluida. Puede ser por beber mucha agua, pero tambi√©n puede ser un signo de que los ri√±ones han perdido su capacidad para concentrar la orina.', advice: `La orina est√° muy diluida. Consejo: Si no est√°s bebiendo cantidades excesivas de agua, es importante que tu m√©dico eval√∫e por qu√© tus ri√±ones no est√°n concentrando la orina correctamente. ${HYDRATION_ADVICE}`, question: 'Mi densidad urinaria es baja. ¬øPodr√≠a estar relacionado con mi ingesta de l√≠quidos o indica un problema renal?' };
                    return { conventional: 'Rango: 1.005 - 1.030', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Una densidad alta significa que la orina est√° muy concentrada. La causa m√°s com√∫n es la deshidrataci√≥n, pero tambi√©n puede indicar la presencia de sustancias como glucosa o prote√≠nas.', advice: `La orina est√° muy concentrada, generalmente por deshidrataci√≥n. Consejo: Aumenta tu ingesta de agua de inmediato. ${HYDRATION_ADVICE}`, question: 'Mi densidad urinaria es alta. ¬øEs probable que est√© deshidratado o deber√≠amos buscar otras sustancias en mi orina?' };
                }
            },
            urinalysisLeukocytes: {
                label: 'Leucocitos (Orina)', unit: '', keywords: ['leucocitos'], type: 'text',
                interpret: (v) => {
                    if (v === 'negativo') return { conventional: 'Rango: Negativo', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'No hay se√±ales de "soldados" en tu orina, lo que indica que no hay una batalla (infecci√≥n) en tu tracto urinario.', advice: '¬°Todo en calma! Negativo para leucocitos significa que no hay signos de infecci√≥n o inflamaci√≥n en tu tracto urinario. ¬°Sigue as√≠!' };
                    return { conventional: 'Rango: Negativo', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'La presencia de "soldados" (leucocitos) en la orina es un signo cl√°sico de una infecci√≥n del tracto urinario (ITU). Tu cuerpo ha enviado al ej√©rcito para combatir a los invasores.', advice: '¬°Alerta de infecci√≥n! La presencia de leucocitos es un signo claro de una ITU. Consulta a tu m√©dico; probablemente necesites un urocultivo y tratamiento.', question: 'Tengo leucocitos en la orina. ¬øDeber√≠amos hacer un urocultivo para identificar la bacteria y tratar la infecci√≥n?' };
                }
            },
            urinalysisNitrites: {
                label: 'Nitritos (Orina)', unit: '', keywords: ['nitritos'], type: 'text',
                interpret: (v) => { 
                    if (v === 'negativo') return { conventional: 'Rango: Negativo', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Negativo para nitritos es una buena se√±al. Significa que no hay "huellas" qu√≠micas de las bacterias m√°s comunes que causan infecciones urinarias.', advice: '¬°Sin rastros de bacterias! Este es un excelente indicador de que no tienes una infecci√≥n urinaria por las bacterias m√°s comunes. ¬°Bien hecho!' };
                    return { conventional: 'Rango: Negativo', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Un resultado positivo es una fuerte evidencia de una infecci√≥n bacteriana. <strong>Es como encontrar las "c√°scaras de pl√°tano" que dejan los microbios tras de s√≠.</strong> Confirma que hay bacterias trabajando activamente.', advice: '¬°Confirmado! Los nitritos positivos son una se√±al casi segura de infecci√≥n bacteriana. Es crucial que hables con tu m√©dico para iniciar el tratamiento adecuado.', question: 'Mis nitritos son positivos. ¬øConfirma esto una ITU y cu√°l ser√≠a el siguiente paso?' };
                }
            },
            urinalysisPh: {
                label: 'pH Orina', unit: '', keywords: ['ph'], type: 'numeric',
                interpret: (v) => {
                    if (v >= 5 && v <= 7) return { conventional: 'Rango: 5.0 - 7.0', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tu pH urinario est√° en un rango normal. Refleja un buen equilibrio √°cido-base en tu cuerpo, influenciado por tu dieta y metabolismo.', advice: '¬°Equilibrio perfecto! Un pH normal refleja un buen balance en tu cuerpo. Consejo: Una dieta variada con frutas y verduras ayuda a mantener este equilibrio.' };
                    if (v < 5) return { conventional: 'Rango: 5.0 - 7.0', tag: { text: '√ÅCIDA', color: 'bg-yellow-500' }, physiological: 'Una orina √°cida puede ser causada por una dieta alta in prote√≠nas, acidosis metab√≥lica o ciertos tipos de c√°lculos renales. <strong>Es como si tu cuerpo estuviera eliminando un exceso de "√°cidos".</strong>', advice: 'Tu orina es √°cida. Consejo: Si tienes antecedentes de c√°lculos renales, esto es importante. Incrementar el consumo de vegetales y reducir las carnes rojas puede ayudar a alcalinizar la orina.' };
                    return { conventional: 'Rango: 5.0 - 7.0', tag: { text: 'ALCALINA', color: 'bg-yellow-500' }, physiological: 'Una orina alcalina puede deberse a una dieta rica en vegetales, a ciertos tipos de infecciones urinarias (bacterias que producen amon√≠aco) o a problemas renales. <strong>Es como si tu cuerpo estuviera eliminando un exceso de "bases".</strong>', advice: 'Tu orina es alcalina. Consejo: Si no es por una dieta vegetariana, com√©ntalo a tu m√©dico, ya que podr√≠a estar relacionado con una infecci√≥n urinaria.', question: `Mi pH urinario est√° en ${v}. ¬øC√≥mo se relaciona esto con mi dieta y mi riesgo de c√°lculos renales?` };
                }
            },
             urinalysisKetones: {
                label: 'Cetonas (Orina)', unit: '', keywords: ['cetonas'], type: 'text',
                interpret: (v, diet) => {
                    if (diet === 'keto' && v !== 'negativo') return { conventional: 'Rango: Negativo', tag: { text: 'ESPERADO', color: 'bg-blue-500' }, physiological: 'Positivo para cetonas es normal y esperado en una dieta cetog√©nica. Significa que tu cuerpo est√° en cetosis, usando grasa como su principal fuente de energ√≠a. <strong>¬°Est√°s quemando grasa!</strong>', advice: '¬°Est√°s en cetosis! Este resultado es el objetivo de una dieta keto. Significa que tu cuerpo est√° usando eficientemente la grasa como combustible. ¬°Sigue as√≠!' };
                    if (v === 'negativo') return { conventional: 'Rango: Negativo', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Negativo para cetonas es lo normal para la mayor√≠a de las dietas. Indica que tu cuerpo est√° usando glucosa (carbohidratos) como su principal combustible.', advice: 'Resultado normal. Tu cuerpo est√° usando carbohidratos como energ√≠a. Si tu objetivo es entrar en cetosis, deber√°s reducir a√∫n m√°s los carbohidratos.' };
                    return { conventional: 'Rango: Negativo', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'La presencia de cetonas sin seguir una dieta baja en carbohidratos puede ser una se√±al de alerta, especialmente si la glucosa en sangre es alta. Podr√≠a indicar cetoacidosis diab√©tica, una emergencia m√©dica.', advice: '¬°Atenci√≥n! Cetonas en la orina sin una dieta keto puede ser peligroso, especialmente si eres diab√©tico. Contacta a tu m√©dico de inmediato.', question: 'Tengo cetonas en la orina sin estar en una dieta keto. ¬øDeber√≠amos medir mi glucosa en sangre para descartar cetoacidosis?' };
                }
            },
            urinalysisProtein: {
                label: 'Prote√≠na (Orina)', unit: '', keywords: ['proteina'], type: 'text',
                interpret: (v) => {
                    if (v === 'negativo') return { conventional: 'Rango: Negativo', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Negativo es el resultado normal. Significa que los "filtros" de tus ri√±ones est√°n funcionando correctamente y no dejan escapar prote√≠nas importantes a la orina.', advice: '¬°Ri√±ones saludables! Un resultado negativo es excelente. Muestra que los filtros de tus ri√±ones est√°n intactos y funcionando bien. ' };
                    return { conventional: 'Rango: Negativo', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'La presencia de prote√≠nas en la orina (proteinuria) es una se√±al temprana y clave de da√±o renal. Indica que los "filtros" est√°n da√±ados y se han vuelto permeables.', advice: '¬°Alerta renal! La presencia de prote√≠nas en la orina es una se√±al temprana de da√±o en los ri√±ones. Es crucial que hables con tu m√©dico para investigar la causa y proteger tu funci√≥n renal.', question: 'Tengo prote√≠nas en la orina. ¬øQu√© tan seria es esta se√±al de da√±o renal y qu√© podemos hacer para proteger mis ri√±ones?' };
                }
            },
            urinalysisGlucose: {
                label: 'Glucosa (Orina)', unit: '', keywords: ['glucosa (o)', 'glucosa (0)', 'glucosa o'], type: 'text',
                interpret: (v) => {
                    if (v === 'negativo') return { conventional: 'Rango: Negativo', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Negativo es normal. Tus ri√±ones son capaces de reabsorber toda la glucosa filtrada, por lo que no deber√≠a aparecer en la orina.', advice: '¬°Buen control del az√∫car! Negativo para glucosa en orina es el resultado ideal. Muestra que tus niveles de az√∫car en sangre no son excesivamente altos.' };
                    return { conventional: 'Rango: Negativo', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'La presencia de glucosa en la orina (glucosuria) ocurre cuando los niveles de az√∫car en la sangre son tan altos que superan la capacidad de los ri√±ones para reabsorberla. Es un signo cl√°sico de diabetes no controlada.', advice: '¬°Az√∫car alta! La glucosa solo aparece en la orina cuando los niveles en sangre son muy elevados. Es un signo claro de diabetes descontrolada. Habla con tu m√©dico urgentemente.', question: 'Tengo glucosa en la orina. ¬øIndica esto que mi nivel de az√∫car en sangre es muy elevado?' };
                }
            },
            urinalysisBlood: {
                label: 'Sangre (Orina)', unit: '', keywords: ['sangre'], type: 'text',
                interpret: (v) => {
                    if (v === 'negativo') return { conventional: 'Rango: Negativo', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Negativo es el resultado normal. No deber√≠a haber sangre en la orina.', advice: '¬°Todo bien! No tener sangre en la orina es el resultado normal y esperado.' };
                    return { conventional: 'Rango: Negativo', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'La presencia de sangre (hematuria), incluso microsc√≥pica, siempre requiere investigaci√≥n. Puede ser causada por infecciones, c√°lculos renales, o condiciones m√°s serias.', advice: 'La presencia de sangre en la orina siempre debe ser investigada por un m√©dico. Puede ir desde una simple infecci√≥n hasta c√°lculos renales. No lo ignores.', question: 'Se detect√≥ sangre en mi orina. ¬øCu√°l es el plan para investigar la causa?' };
                }
            },
             urinalysisUrobilinogen: {
                label: 'Urobilin√≥geno', unit: '', keywords: ['urobilinogeno'], type: 'text',
                interpret: (v) => {
                    if (v === 'normal') return { conventional: 'Rango: Normal', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Un nivel normal indica que tu h√≠gado y tus intestinos est√°n procesando la bilirrubina correctamente.', advice: '¬°Funci√≥n hep√°tica en orden! Un resultado normal aqu√≠ es una buena se√±al del trabajo en equipo entre tu h√≠gado y tu sistema digestivo.' };
                    return { conventional: 'Rango: Normal', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Niveles anormales pueden sugerir problemas hep√°ticos o una destrucci√≥n excesiva de gl√≥bulos rojos.', advice: 'Un resultado anormal aqu√≠ puede ser una pista temprana de problemas hep√°ticos. Com√©ntalo con tu m√©dico para una evaluaci√≥n m√°s profunda.', question: 'Mi urobilin√≥geno est√° fuera del rango normal. ¬øDeber√≠amos investigar la salud de mi h√≠gado?' };
                }
            },
            urinalysisBilirubin: {
                label: 'Bilirrubina (Orina)', unit: '', keywords: ['bilirrubina'], type: 'text',
                interpret: (v) => {
                    if (v === 'negativo') return { conventional: 'Rango: Negativo', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Negativo es el resultado normal. La bilirrubina no deber√≠a estar presente en la orina si el h√≠gado funciona bien.', advice: '¬°H√≠gado funcionando bien! Negativo para bilirrubina en orina es una excelente se√±al de salud hep√°tica.' };
                    return { conventional: 'Rango: Negativo', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'La presencia de bilirrubina en la orina es un signo temprano de enfermedad hep√°tica o de una obstrucci√≥n en las v√≠as biliares.', advice: '¬°Alerta hep√°tica! La bilirrubina en la orina es un signo claro de que tu h√≠gado no est√° procesando los desechos correctamente. Consulta a tu m√©dico sin demora.', question: 'Tengo bilirrubina en la orina. ¬øEs esto una se√±al clara de un problema hep√°tico?' };
                }
            },
            urinalysisSedimentLeukocytes: {
                label: 'Leucocitos (Sedimento)', unit: 'por campo', keywords: ['leucocitos '], type: 'text',
                interpret: (v) => {
                    const numericValue = parseInt(v.split('-')[1] || v.split('-')[0]);
                    if (numericValue < 5) return { conventional: 'Rango: < 5 por campo', tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Un conteo bajo de leucocitos en el sedimento confirma la ausencia de inflamaci√≥n o infecci√≥n en el tracto urinario.', advice: '¬°Confirmado, sin infecci√≥n! El an√°lisis microsc√≥pico no muestra signos de inflamaci√≥n. Tu tracto urinario est√° saludable.' };
                    return { conventional: 'Rango: < 5 por campo', tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Un conteo elevado en el sedimento es una confirmaci√≥n visual de la presencia de "soldados" y refuerza el diagn√≥stico de una posible ITU.', advice: 'El microscopio confirma la infecci√≥n. Un conteo elevado de leucocitos es una prueba definitiva de ITU. Sigue las indicaciones de tu m√©dico.', question: 'Mi sedimento muestra un conteo elevado de leucocitos. ¬øQu√© tan severa es la infecci√≥n?' };
                }
            },
            urinalysisEpithelialCells: {
                label: 'C√©lulas Epiteliales', unit: 'por campo', keywords: ['celulas epiteliales'], type: 'text',
                interpret: (v) => {
                    return { conventional: '', tag: { text: 'INFO', color: 'bg-gray-500' }, physiological: `La presencia de algunas c√©lulas epiteliales (${v}) es normal, ya que se desprenden de forma natural. Un n√∫mero muy elevado podr√≠a sugerir inflamaci√≥n.`, advice: 'Este es un hallazgo normal. El revestimiento de tu tracto urinario se renueva constantemente, por lo que es com√∫n ver algunas c√©lulas en la orina.' };
                }
            },
            urinalysisMucus: {
                label: 'Mucus', unit: '', keywords: ['mucus'], type: 'text',
                interpret: (v) => {
                    return { conventional: '', tag: { text: 'INFO', color: 'bg-gray-500' }, physiological: `Una cantidad ${v} de mucus es generalmente normal y no indica un problema.`, advice: 'Hallazgo sin importancia cl√≠nica. La presencia de moco en peque√±as cantidades es normal y no representa un problema de salud.' };
                }
            },
            urinalysisAmorphousUrates: {
                label: 'Urato Amorfo', unit: '', keywords: ['urato amorfo'], type: 'text',
                interpret: (v) => {
                    return { conventional: '', tag: { text: 'INFO', color: 'bg-gray-500' }, physiological: `Una cantidad ${v} de urato amorfo es com√∫n en orinas √°cidas y concentradas. Generalmente no es un signo de enfermedad, pero en grandes cantidades podr√≠a estar relacionado con el riesgo de c√°lculos de √°cido √∫rico.`, advice: `Com√∫n y generalmente benigno. Estos cristales aparecen si tu orina est√° concentrada o es √°cida. Consejo: Mantener una buena hidrataci√≥n ayuda a prevenirlos. ${HYDRATION_ADVICE}` };
                }
            },
            psa: {
                label: 'Ant√≠geno Prost√°tico (PSA)', unit: 'ng/mL', keywords: ['antigeno prostatico', 'psa'], type: 'numeric',
                interpret: (v, age) => {
                    let limit = 4.0;
                    if (age < 50) limit = 2.5;
                    if (age >= 60 && age < 70) limit = 4.5;
                    if (age >= 70) limit = 6.5;
                    if (v < limit) return { conventional: `Rango: < ${limit} ng/mL (ajustado por edad)`, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: `Tu nivel de PSA est√° dentro del rango esperado para tu edad. <strong>Es una buena noticia,</strong> ya que sugiere un bajo riesgo de condiciones prost√°ticas significativas en este momento. Es importante seguir monitore√°ndolo seg√∫n las recomendaciones m√©dicas.`, advice: '¬°Excelente noticia! Tu PSA est√° en un rango seguro para tu edad. Consejo: Contin√∫a con tus chequeos regulares seg√∫n la recomendaci√≥n de tu m√©dico.' };
                    return { conventional: `Rango: < ${limit} ng/mL (ajustado por edad)`, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: `Tu nivel de PSA est√° por encima del rango de referencia para tu edad. <strong>Esto no significa que tengas c√°ncer.</strong> Las causas m√°s comunes de un PSA elevado son la inflamaci√≥n (prostatitis) o el agrandamiento benigno de la pr√≥stata (HPB). Sin embargo, es una se√±al que justifica una evaluaci√≥n m√°s profunda por parte de un ur√≥logo.`, advice: 'Este valor necesita ser evaluado por un ur√≥logo. No te alarmes, puede deberse a inflamaci√≥n o crecimiento benigno, pero es crucial investigarlo para descartar problemas serios.', question: `Mi PSA est√° en ${v}, que es elevado para mi edad. ¬øCu√°les son los siguientes pasos para investigar la causa, como un examen de orina, un tacto rectal o un an√°lisis de PSA Libre?` };
                }
            },
            colesterolTotal: { 
                label: 'Colesterol Total', unit: 'mg/dL', keywords: ['colesterol total'], type: 'numeric',
                interpret: (v) => ({ 
                    conventional: 'Rango de laboratorio: 140 - 200 mg/dL.', 
                    tag: {text: 'INFO', color: 'bg-gray-500'}, 
                    physiological: 'Un valor aislado dice poco, ya que suma todo tipo de colesterol sin diferenciar su funci√≥n. Su verdadero significado aparece al compararlo con el HDL y los Triglic√©ridos. <strong>Pi√©nsalo as√≠:</strong> saber el n√∫mero total de veh√≠culos en una autopista (Colesterol Total) no te dice si son ambulancias salvando vidas (HDL) o camiones botando basura (part√≠culas de LDL peque√±as y densas). Un Colesterol Total alto con un HDL alto y Triglic√©ridos bajos es un escenario metab√≥lico muy favorable, indicando que la mayor√≠a de tus "veh√≠culos" son beneficiosos y eficientes.',
                    advice: 'Este es un marcador general. En lugar de enfocarte en este n√∫mero, presta m√°s atenci√≥n a tus niveles de Triglic√©ridos y HDL, ya que ellos cuentan la verdadera historia de tu salud metab√≥lica.'
                }) 
            },
            ldl: { 
                label: 'Colesterol LDL', unit: 'mg/dL', keywords: ['colesterol ldl', 'ldl-c', 'ldl'], type: 'numeric',
                interpret: (v, diet, tgHdlRatio) => {
                    let interpretation = { conventional: 'Rango de laboratorio: < 130 mg/dL.' };
                    if (diet === 'keto' && v > 130 && tgHdlRatio && tgHdlRatio < 2) {
                        return { ...interpretation, tag: {text: 'CONTEXTO', color: 'bg-blue-500'}, physiological: 'En un entorno bajo en carbohidratos, el cuerpo usa m√°s grasa como combustible, por lo que necesita m√°s "camiones de reparto" (LDL) para transportar esta energ√≠a. Un LDL elevado puede reflejar este aumento en el transporte y no necesariamente un mayor riesgo, sobre todo si tus triglic√©ridos son bajos y tu HDL es alto. Este perfil se conoce como "Hiper-respondedor de Masa Magra" y es un √°rea de investigaci√≥n activa.', advice: 'Tu LDL es alto, pero en el contexto de una dieta keto y buena salud metab√≥lica, puede no ser un problema. Consejo: Habla con tu m√©dico sobre pruebas avanzadas como ApoB o Lp(a) para evaluar tu riesgo real.', question: 'Dado que mis triglic√©ridos son bajos y mi HDL alto, ¬øc√≥mo deber√≠amos interpretar mi colesterol LDL elevado en el contexto de mi salud metab√≥lica general?' };
                    }
                    if (v < 100) return { ...interpretation, tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: 'Un nivel bajo de LDL sugiere que hay un n√∫mero adecuado de "camiones de reparto" en tus arterias, lo que minimiza la probabilidad de "embotellamientos" y "accidentes" (formaci√≥n de placa ateroscler√≥tica). Es un excelente indicador de bajo riesgo cardiovascular.', advice: '¬°Felicidades! Un LDL bajo es ideal. Consejo: Para mantenerlo as√≠, sigue una dieta baja en az√∫cares y grasas trans, y mant√©n un estilo de vida activo.' };
                    if (v < 160) return { ...interpretation, tag: {text: 'MEJORABLE', color: 'bg-yellow-500'}, physiological: 'Hay un tr√°fico moderado de "camiones de reparto". No es una se√±al de alarma, pero es una buena oportunidad para revisar si la "carga" que llevan (triglic√©ridos) es alta y si los "camiones" son del tipo peque√±o y denso, que son los m√°s problem√°ticos.', advice: 'Tu LDL es mejorable. Consejo: Reduce el consumo de carbohidratos refinados (pan blanco, pastas, dulces) y aumenta la fibra (vegetales, legumbres) para ayudar a reducirlo.' };
                    return { ...interpretation, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Hay un "tr√°fico" muy elevado de "camiones de reparto". Si esto se combina con triglic√©ridos altos y HDL bajo, es una se√±al de alerta. Sugiere que los "camiones" son peque√±os, densos y propensos a oxidarse y quedarse "atascados" en las paredes de las arterias, lo que aumenta significativamente el riesgo cardiovascular.', advice: 'Un LDL alto requiere acci√≥n. Consejo: Es fundamental reducir dr√°sticamente el az√∫car y las harinas refinadas, aumentar la actividad f√≠sica y hablar con tu m√©dico sobre posibles estrategias adicionales.', question: 'Mi LDL es alto. ¬øDeber√≠amos considerar un an√°lisis del tama√±o de las part√≠culas de LDL (un perfil ApoB o NMR) para entender mejor mi riesgo real?' };
                }
            },
            hdl: { 
                label: 'Colesterol HDL', unit: 'mg/dL', keywords: ['colesterol hdl', 'hdl-c', 'hdl'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango de laboratorio: > 40 mg/dL.' };
                    if (v > 60) return { ...interpretation, tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: '¬°Excelente! Tienes un "equipo de limpieza y mantenimiento" de arterias muy robusto y eficiente. Un HDL alto no solo limpia el colesterol, sino que tambi√©n tiene potentes efectos antiinflamatorios y antioxidantes, siendo un fuerte factor de protecci√≥n cardiovascular.', advice: '¬°Excelente! Para mantener un HDL alto, sigue priorizando el ejercicio regular (especialmente HIIT), y el consumo de grasas saludables como palta, aceite de oliva, frutos secos y pescados grasos.'  };
                    if (v >= 40) return { ...interpretation, tag: {text: 'ACEPTABLE', color: 'bg-yellow-500'}, physiological: 'Tu "equipo de limpieza" est√° funcionando, pero podr√≠a ser m√°s numeroso y forte. El ejercicio (especialmente el de alta intensidad), el consumo de grasas saludables (palta, aceite de oliva, pescado) y dejar de fumar son sus mejores aliados para potenciarlo.', advice: 'Est√°s en un buen camino, pero puedes mejorar. Consejo: Aumenta la intensidad de tu ejercicio y aseg√∫rate de incluir fuentes de grasa monoinsaturada en cada comida (como un chorrito de aceite de oliva en tu ensalada).' };
                    return { ...interpretation, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Tu "equipo de limpieza" est√° debilitado o es insuficiente. Esto es un factor de riesgo cardiovascular independiente, a menudo ligado a la resistencia a la insulina, la inflamaci√≥n cr√≥nica y un estilo de vida sedentario. Es una se√±al de que tus arterias no se est√°n "manteniendo" adecuadamente.', advice: 'Acci√≥n recomendada: Aumentar el HDL es clave. Enf√≥cate en el ejercicio (caminar, nadar, correr) y aumenta tu consumo de grasas monoinsaturadas (aceite de oliva, palta). Reducir el consumo de az√∫cares y harinas refinadas tambi√©n es fundamental.', question: 'Mi HDL est√° bajo. ¬øQu√© cambios de estilo de vida ser√≠an m√°s efectivos para fortalecer mi sistema de "limpieza" arterial y reducir la inflamaci√≥n?' };
                }
            },
            triglycerides: { 
                label: 'Triglic√©ridos', unit: 'mg/dL', keywords: ['trigliceridos'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango de laboratorio: < 150 mg/dL.' };
                    if (v < 100) return { ...interpretation, tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: 'Excelente. Esto refleja que tu cuerpo est√° gestionando muy bien la energ√≠a que consumes, especialmente los carbohidratos. <strong>Es como si tuvieras un motor muy eficiente que quema el combustible al instante en lugar de almacenarlo.</strong> Unos triglic√©ridos bajos son un pilar de la buena salud metab√≥lica.', advice: '¬°Felicidades, este es uno de los marcadores m√°s importantes! Unos triglic√©ridos bajos indican una excelente salud metab√≥lica. Consejo: Sigue evitando los az√∫cares y carbohidratos procesados.' };
                    if (v < 150) return { ...interpretation, tag: {text: 'ACEPTABLE', color: 'bg-yellow-500'}, physiological: 'Est√°s dentro del rango convencional, pero un valor por debajo de 100 es metab√≥licamente preferible. Este nivel puede ser una primera se√±al de que tu "tanque de reserva" de energ√≠a empieza a llenarse con m√°s frecuencia de la deseada, usualmente por un exceso de az√∫cares y harinas refinadas.', advice: 'Est√°s en rango, pero podr√≠as mejorar. Consejo: Reemplaza las bebidas azucaradas por agua y reduce el consumo de pan, pastas y postres para bajar este n√∫mero.' };
                    return { ...interpretation, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Nivel elevado. Es una se√±al directa de que tu h√≠gado est√° trabajando horas extras convirtiendo el exceso de carbohidratos y az√∫cares en grasa. <strong>Imagina que tu h√≠gado es una f√°brica que, al recibir demasiada materia prima (az√∫car), la empaqueta como grasa (triglic√©ridos) y la env√≠a a la sangre.</strong> Esto es un signo cl√°sico de resistencia a la insulina.', advice: '¬°Alerta metab√≥lica! Unos triglic√©ridos altos son una se√±al clara de resistencia a la insulina. Acci√≥n inmediata: Elimina todas las bebidas azucaradas y reduce al m√≠nimo los alimentos a base de harina y az√∫car.', question: 'Mis triglic√©ridos est√°n elevados. ¬øEs esta la se√±al m√°s directa de que mi consumo de carbohidratos y az√∫cares es demasiado alto para lo que mi cuerpo puede manejar?' };
                }
            },
             noHdl: { 
                label: 'Colesterol No HDL', unit: 'mg/dL', keywords: ['colesterol no hdl'], type: 'numeric',
                interpret: (v) => {
                    if (v < 130) return { conventional: 'Rango: < 150 mg/dL', tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: 'Indica una baja carga total de part√≠culas que pueden depositarse en las arterias. <strong>Es como saber que el n√∫mero total de "veh√≠culos problem√°ticos" en la autopista es bajo.</strong> Es una excelente se√±al de salud cardiovascular, considerada por muchos expertos como un mejor predictor de riesgo que el LDL por s√≠ solo.', advice: '¬°Muy bien! Este es un marcador muy importante y tenerlo bajo es excelente. Refleja una baja cantidad de part√≠culas que pueden da√±ar tus arterias.' };
                    return { ...interpretation, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Un nivel elevado sugiere que hay una alta concentraci√≥n de part√≠culas aterog√©nicas en tu sangre, lo que aumenta el riesgo cardiovascular a largo plazo, independientemente de tu nivel de LDL.', advice: 'Este n√∫mero es m√°s importante que el LDL solo. Un No-HDL alto requiere los mismos consejos que para el LDL y los Triglic√©ridos: reducir az√∫cares y carbohidratos refinados.', question: `Mi colesterol No-HDL est√° elevado en ${v}. ¬øDeber√≠amos darle m√°s importancia a este marcador que a mi LDL aislado para evaluar mi riesgo cardiovascular?` };
                }
            },
            relacionTotalHdl: { 
                label: 'Relaci√≥n Total/HDL', unit: '', keywords: ['relacion total/hdl'], type: 'numeric',
                interpret: (v) => {
                    if (v < 3.5) return { conventional: 'Rango: 0 - 5', tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: 'Un ratio bajo es un excelente indicador de bajo riesgo cardiovascular. <strong>Significa que tienes muchos "equipos de limpieza" (HDL) en proporci√≥n a todo el "tr√°fico" (Colesterol Total).</strong> ¬°Tu equipo de limpieza est√° manejando bien la situaci√≥n!', advice: '¬°Excelente equilibrio! Este ratio demuestra que tu colesterol protector (HDL) es abundante en comparaci√≥n con el resto. ¬°Sigue con los h√°bitos que te llevaron aqu√≠!' };
                    return { conventional: 'Rango: 0 - 5', tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Un ratio elevado sugiere un desequilibrio: hay demasiado "tr√°fico" para la capacidad de tu "equipo de limpieza", lo que aumenta el riesgo de "accidentes" y "embotellamientos" en tus arterias.', advice: 'Este desequilibrio es un factor de riesgo. Para mejorarlo, necesitas bajar el colesterol total (reduciendo az√∫cares) y subir el HDL (con ejercicio y grasas saludables).', question: `Mi relaci√≥n Colesterol Total/HDL est√° en ${v}. ¬øQu√© significa este desequilibrio para mi riesgo cardiovascular a largo plazo?` };
                }
            },
            relacionLdlHdl: { 
                label: 'Relaci√≥n LDL/HDL', unit: '', keywords: ['relacion ldl/hdl'], type: 'numeric',
                interpret: (v) => {
                    if (v < 2.0) return { conventional: 'Rango: 0 - 3.5', tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: 'Un ratio bajo indica un excelente equilibrio. Hay m√°s capacidad de limpieza que de reparto, lo cual es protector. <strong>Es como tener m√°s personal de mantenimiento que repartidores,</strong> asegurando que las calles siempre est√©n limpias.', advice: '¬°Equilibrio ideal! Tienes una proporci√≥n saludable entre el colesterol "de reparto" y el "de limpieza". Es un fuerte indicador de protecci√≥n cardiovascular.' };
                    return { conventional: 'Rango: 0 - 3.5', tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Un ratio elevado sugiere que hay m√°s "camiones repartiendo" que "equipo limpiando", lo cual es un factor de riesgo a largo plazo, ya que aumenta la probabilidad de que el colesterol se acumule en las arterias.', advice: 'Este ratio muestra un desbalance. La estrategia es doble: bajar el LDL (menos az√∫car y carbohidratos procesados) y subir el HDL (m√°s ejercicio y grasas buenas).', question: `Mi relaci√≥n LDL/HDL est√° en ${v}. ¬øC√≥mo podemos mejorar este equilibrio espec√≠fico entre las part√≠culas LDL y HDL?` };
                }
            },
            rbc: { label: 'Eritrocitos', unit: '10^6/uL', keywords: ['eritrocitos', 'globulos rojos', 'hematies'], type: 'numeric',
                interpret: (v, sex) => {
                const range = sex === 'male' ? '4.5-5.9' : '4.0-5.2';
                const isOptimal = sex === 'male' ? (v >= 4.5 && v <= 5.9) : (v >= 4.0 && v <= 5.2);
                if (isOptimal) return { conventional: `Rango: ${range}`, tag: {text: 'NORMAL', color: 'bg-green-500'}, physiological: 'Tu cantidad de "camiones de reparto de ox√≠geno" est√° en un rango saludable. Esto asegura que todas tus c√©lulas reciben el combustible que necesitan para funcionar correctamente.', advice: 'Tus niveles de gl√≥bulos rojos son saludables. Consejo: Para mantenerlos, aseg√∫rate de consumir suficiente hierro (carnes rojas, legumbres), vitamina B12 y √°cido f√≥lico.' };
                return { conventional: `Rango: ${range}`, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Un valor fuera de rango necesita atenci√≥n. Si es bajo, podr√≠as tener muy pocos "camiones de ox√≠geno" (anemia), causando fatiga. Si es alto, la sangre puede volverse muy "espesa", lo que podr√≠a indicar deshidrataci√≥n o una sobreproducci√≥n de c√©lulas.', advice: 'Un valor fuera de rango requiere evaluaci√≥n m√©dica para determinar la causa, ya sea anemia, deshidrataci√≥n u otra condici√≥n.', question: `Mis eritrocitos est√°n en ${v}, fuera del rango de referencia. ¬øQu√© podr√≠a significar esto para mi energ√≠a y mi estado de hidrataci√≥n?` };
            }},
            hemoglobin: { label: 'Hemoglobina', unit: 'g/dL', keywords: ['hemoglobina'], type: 'numeric',
                interpret: (v, sex) => {
                const range = sex === 'male' ? '13.5-17.5' : '12.0-15.5';
                const isOptimal = sex === 'male' ? (v >= 13.5 && v <= 17.5) : (v >= 12.0 && v <= 15.5);
                if (isOptimal) return { conventional: `Rango: ${range} g/dL`, tag: {text: 'NORMAL', color: 'bg-green-500'}, physiological: 'Tu capacidad para transportar ox√≠geno es saludable. Cada "cami√≥n" (gl√≥bulo rojo) lleva una carga completa de "paquetes de ox√≠geno" (hemoglobina).', advice: 'Tu capacidad de transporte de ox√≠geno es ideal. Consejo: Mant√©n una dieta rica en hierro y vitaminas del complejo B para asegurar una buena producci√≥n de hemoglobina.' };
                return { conventional: `Rango: ${range} g/dL`, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Niveles bajos son el principal indicador de anemia; tus "camiones" no llevan suficiente ox√≠geno. Niveles altos pueden estar relacionados con deshidrataci√≥n (la sangre est√° m√°s concentrada) o problemas pulmonares (el cuerpo intenta compensar la falta de aire creando m√°s transportadores).', advice: `Un nivel bajo es el principal signo de anemia. Un nivel alto puede indicar deshidrataci√≥n. Para ello, ${HYDRATION_ADVICE.toLowerCase().replace('recuerda que ', '')} En ambos casos, es necesaria una evaluaci√≥n m√©dica.`, question: `Mi hemoglobina est√° en ${v}. ¬øDeber√≠amos investigar una posible anemia o revisar mi estado de hidrataci√≥n?` };
            }},
            hematocrit: { label: 'Hematocrito', unit: '%', keywords: ['hematocrito'], type: 'numeric',
                interpret: (v, sex) => {
                const range = sex === 'male' ? '41-53' : '36-46';
                const isOptimal = sex === 'male' ? (v >= 41 && v <= 53) : (v >= 36 && v <= 46);
                if (isOptimal) return { conventional: `Rango: ${range} %`, tag: {text: 'NORMAL', color: 'bg-green-500'}, physiological: 'La proporci√≥n de tus gl√≥bulos rojos en la sangre es adecuada. <strong>Imagina un vaso de agua con frutillas:</strong> el hematocrito te dice qu√© porcentaje del vaso est√° ocupado por las frutillas (gl√≥bulos rojos) en comparaci√≥n con el agua (plasma).', advice: `Una buena proporci√≥n entre tus c√©lulas y el plasma sangu√≠neo. Consejo: Mantener una buena hidrataci√≥n es clave para que este valor se mantenga en rango. ${HYDRATION_ADVICE}` };
                return { conventional: `Rango: ${range} %`, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Un valor bajo puede indicar anemia (pocas "frutillas"). Un valor alto puede indicar deshidrataci√≥n (poca "agua", lo que hace que las frutillas parezcan m√°s concentradas) o una producci√≥n excesiva de gl√≥bulos rojos.', advice: `Un valor alto suele indicar deshidrataci√≥n (bebe m√°s agua). ${HYDRATION_ADVICE} Un valor bajo puede ser se√±al de anemia. Consulta a tu m√©dico.`, question: `Mi hematocrito est√° en ${v}. ¬øPodr√≠a estar relacionado con mi estado de hidrataci√≥n o una posible anemia?` };
            }},
            wbc: { label: 'Leucocitos (Sangre)', unit: 'x10^3/uL', keywords: ['globulos blancos'], type: 'numeric',
                interpret: (v) => {
                if (v >= 4.5 && v <= 11.0) return { conventional: 'Rango: 4.5-11.0', tag: {text: 'NORMAL', color: 'bg-green-500'}, physiological: 'Tu "ej√©rcito de defensa" parece estar en calma y en niveles normales. No hay se√±ales de una batalla importante en este momento.', advice: 'Tu sistema inmune est√° en calma. Consejo: Para mantenerlo fuerte, aseg√∫rate de dormir bien, manejar el estr√©s y tener una dieta rica en nutrientes.' };
                return { conventional: `Rango: 4.5-11.0`, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Valores alterados son una se√±al. Si est√°n altos, tu "ej√©rcito" ha sido movilizado para luchar contra una infecci√≥n o inflamaci√≥n. Si est√°n bajos, podr√≠a indicar una "defensa debilitada" o que las "tropas" se han agotado tras una larga batalla.', advice: 'Un valor fuera de rango indica que tu sistema inmune est√° activo. Si est√° alto, probablemente est√©s combatiendo una infecci√≥n. Si est√° bajo, tus defensas podr√≠an estar debilitadas. Habla con tu m√©dico.', question: `Mis leucocitos est√°n en ${v}. ¬øPodr√≠a indicar esto una infecci√≥n o inflamaci√≥n que no he notado?` };
            }},
            platelets: { label: 'Plaquetas', unit: 'x10^3/uL', keywords: ['plaquetas'], type: 'numeric',
                interpret: (v) => {
                if (v >= 150 && v <= 450) return { conventional: 'Rango: 150-450', tag: {text: 'NORMAL', color: 'bg-green-500'}, physiological: 'Tu capacidad de coagulaci√≥n y "reparaci√≥n de emergencias" parece estar en orden. Tienes suficientes "param√©dicos" listos para actuar.', advice: 'Tu capacidad de coagulaci√≥n es normal. Es un marcador que generalmente no se modifica con el estilo de vida, pero es bueno saber que est√° bien.' };
                return { conventional: 'Rango: 150-450', tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Un desequilibrio aqu√≠ es importante. Niveles bajos (pocos "param√©dicos") aumentan el riesgo de sangrado y moretones. Niveles altos (demasiados "param√©dicos") pueden aumentar el riesgo de que se formen co√°gulos innecesarios dentro de los vasos sangu√≠neos.', advice: 'Valores fuera de rango deben ser evaluados por un m√©dico para entender la causa, ya que pueden afectar tu capacidad de coagulaci√≥n.', question: `Mis plaquetas est√°n en ${v}. ¬øQu√© implicaciones tiene esto para la coagulaci√≥n y la salud de mis vasos sangu√≠neos?` };
            }},
            vcm: { label: 'V.C.M.', unit: 'fL', keywords: ['v.c.m.', 'vcm'], type: 'numeric',
                interpret: (v) => {
                if (v >= 82 && v <= 96) return { conventional: 'Rango: 82-96 fL', tag: {text: 'NORMAL', color: 'bg-green-500'}, physiological: 'El tama√±o de tus "camiones de ox√≠geno" es normal. Esto sugiere que la "f√°brica" que los produce tiene todos los materiales necesarios (como B12, folato y hierro) para construirlos correctamente.', advice: 'El tama√±o de tus gl√≥bulos rojos es perfecto. Esto sugiere que tienes buenos niveles de Hierro, B12 y Folato. ¬°Sigue con esa dieta nutritiva!' };
                return { conventional: 'Rango: 82-96 fL', tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'El tama√±o importa. Un VCM bajo significa "camiones" peque√±os (microc√≠tica), lo que suele apuntar a falta de hierro. Un VCM alto significa "camiones" grandes e hinchados (macroc√≠tica), lo que puede indicar falta de B12 o folato.', advice: 'El tama√±o de tus gl√≥bulos rojos est√° alterado. Si es bajo, podr√≠a ser falta de hierro. Si es alto, podr√≠a ser falta de B12 o folato. Tu m√©dico te ayudar√° a identificar la causa.', question: `Mi VCM est√° en ${v}. ¬øQu√© nos dice esto sobre la posible causa nutricional de mi anemia?` };
            }},
            hcm: { label: 'H.C.M.', unit: 'pg', keywords: ['h.c.m.', 'hcm'], type: 'numeric',
                interpret: (v) => {
                if (v >= 28 && v <= 32) return { conventional: 'Rango: 28-32 pg', tag: {text: 'NORMAL', color: 'bg-green-500'}, physiological: 'La cantidad de "carga de ox√≠geno" (hemoglobina) dentro de cada "cami√≥n" es la adecuada. Complementa la informaci√≥n del VCM.', advice: 'La cantidad de hemoglobina en cada gl√≥bulo rojo es la correcta. Es otra se√±al de que tu producci√≥n de c√©lulas sangu√≠neas es saludable.' };
                return { conventional: 'Rango: 28-32 pg', tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Este valor ayuda a afinar el diagn√≥stico. Si los "camiones" son peque√±os (VCM bajo) y adem√°s llevan poca "carga" (HCM bajo), refuerza la idea de una anemia por falta de hierro.', advice: 'Este valor alterado, junto al VCM, ayuda a tu m√©dico a diagnosticar el tipo exacto de anemia que podr√≠as tener.' };
            }},
            chcm: { label: 'C.H.C.M.', unit: '%', keywords: ['c.h.c.m.', 'chcm'], type: 'numeric',
                interpret: (v) => {
                if (v >= 33 && v <= 36) return { conventional: 'Rango: 33-36 %', tag: {text: 'NORMAL', color: 'bg-green-500'}, physiological: 'La concentraci√≥n de "carga de ox√≠geno" dentro de tus "camiones" es adecuada. Esto se traduce en un color rojo saludable para las c√©lulas.', advice: 'El color de tus gl√≥bulos rojos es el adecuado. Una buena concentraci√≥n de hemoglobina es sin√≥nimo de eficiencia en el transporte de ox√≠geno.' };
                return { conventional: 'Rango: 33-36 %', tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Valores bajos (hipocrom√≠a) son comunes en anemias por deficiencia de hierro, indicando que los gl√≥bulos rojos est√°n "p√°lidos" o "descoloridos" porque les falta hemoglobina. Es otra pista que apunta hacia el hierro.', advice: 'Un valor bajo indica que tus gl√≥bulos rojos est√°n "p√°lidos", lo que es una se√±al muy fuerte de anemia por deficiencia de hierro. Tu m√©dico probablemente querr√° medir tus niveles de ferritina.', question: `Mi C.H.C.M. est√° bajo. ¬øEs esta una se√±al clara de que mis gl√≥bulos rojos est√°n "p√°lidos" por una posible deficiencia de hierro?` };
            }},
            glucose: { 
                label: 'Glucosa Basal', unit: 'mg/dL', keywords: ['glucosa', 'glicemia'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango normal: 70-100 mg/dL.' };
                    if (v < 90) return { ...interpretation, tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: 'Excelente control gluc√©mico en ayunas. Esto indica que tus c√©lulas son muy "sensibles" a la insulina, la hormona que act√∫a como una llave para dejar entrar el az√∫car y usarla como energ√≠a. Es una se√±al de gran salud metab√≥lica.', advice: '¬°Nivel de az√∫car ideal! Esto refleja una excelente sensibilidad a la insulina. Consejo: Sigue evitando los picos de az√∫car limitando los alimentos procesados y los dulces.' };
                    if (v <= 100) return { ...interpretation, tag: {text: 'ACEPTABLE', color: 'bg-yellow-500'}, physiological: 'A√∫n en rango normal, pero es una se√±al para estar atento. Podr√≠a indicar que tus c√©lulas est√°n empezando a volverse un poco "sordas" a la insulina, necesitando que el cuerpo "grite" m√°s fuerte (produzca m√°s insulina) para hacer el mismo trabajo.', advice: 'Est√°s en la zona de "precauci√≥n". Consejo: Prioriza caminar despu√©s de las comidas y reduce las porciones de carbohidratos (arroz, papas, pan) para mejorar tu sensibilidad a la insulina.' };
                    return { ...interpretation, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Un nivel elevado sugiere que el sistema est√° fallando. O las "llaves" (insulina) no funcionan bien, o las "cerraduras" de las c√©lulas (receptores) est√°n rotas. El az√∫car se queda acumulado en la sangre en lugar de entrar a las c√©lulas, lo que es t√≥xico a largo plazo. Es un signo de pre-diabetes o diabetes.', advice: 'Un nivel de az√∫car alto en ayunas es una se√±al de alerta de pre-diabetes o diabetes. Es crucial que consultes a tu m√©dico para tomar medidas.', question: 'Mi glucosa en ayunas est√° elevada. ¬øDeber√≠amos medir mi insulina en ayunas o una HbA1c para tener una imagen m√°s completa de mi salud metab√≥lica?' };
                }
            },
            uricAcid: {
                label: '√Åcido √örico', unit: 'mg/dL', keywords: ['acido urico', '√°cido √∫rico'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 3.5 - 7.2 mg/dL.' };
                    let baseText = 'Un nivel elevado, o incluso en el rango alto-normal, aumenta el riesgo de gota y es un marcador de disfunci√≥n metab√≥lica. <strong>Imagina que el √°cido √∫rico es el "humo" que genera el motor de tu metabolismo.</strong> Mucho humo indica que el motor est√° trabajando de forma ineficiente. Pero hay m√°s: ese "humo" es corrosivo. El √°cido √∫rico inhibe la producci√≥n de √ìxido N√≠trico, una mol√©cula vital que act√∫a como el "aceite lubricante" de tus arterias, ayud√°ndolas a relajarse y expandirse. Sin suficiente √ìxido N√≠trico, tus arterias se vuelven r√≠gidas, lo que puede aumentar la presi√≥n arterial y el riesgo cardiovascular.';
                    
                    if (v < 5.5) {
                        let physiologicalText = 'Un nivel √≥ptimo sugiere un buen metabolismo de las purinas y bajo riesgo de gota. <strong>M√°s importante a√∫n, es un indicador indirecto de que no est√°s sobrecargando tu h√≠gado con fructosa,</strong> ya que el metabolismo de la fructosa es una de las principales causas de √°cido √∫rico elevado.';
                        return { ...interpretation, tag: { text: '√ìPTIMO', color: 'bg-green-500' }, physiological: physiologicalText, advice: '¬°Excelente! Un √°cido √∫rico bajo es un gran indicador de salud metab√≥lica. Consejo: Sigue evitando las bebidas azucaradas y el exceso de alcohol para mantenerlo en este rango √≥ptimo.' };
                    }
                    if (v <= 7.2) return { ...interpretation, tag: { text: 'ACEPTABLE', color: 'bg-yellow-500' }, physiological: 'Dentro del rango de laboratorio, pero un valor m√°s bajo es preferible. Puede ser un indicador temprano de estr√©s metab√≥lico, especialmente si tu dieta es alta en carnes rojas, mariscos, alcohol o bebidas azucaradas. ' + baseText, advice: 'Est√°s en un rango aceptable, pero m√°s bajo es mejor. Consejo: Reduce el consumo de cerveza, bebidas azucaradas y carnes rojas para disminuir el "humo" metab√≥lico y proteger tus arterias.', question: `Mi √°cido √∫rico est√° en ${v}. Adem√°s de la dieta, ¬øqu√© implicaciones tiene este nivel para mi salud vascular y mi presi√≥n arterial a trav√©s de su efecto sobre el √≥xido n√≠trico?` };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: baseText, advice: 'Un nivel alto requiere atenci√≥n. Afecta tus articulaciones (riesgo de gota) y tus arterias. Consejo: Habla con tu m√©dico sobre un plan diet√©tico estricto para reducirlo.', question: `Mi √°cido √∫rico est√° en ${v}. Adem√°s de la dieta, ¬øqu√© implicaciones tiene este nivel para mi salud vascular y mi presi√≥n arterial a trav√©s de su efecto sobre el √≥xido n√≠trico?` };
                }
            },
            totalProteins: {
                label: 'Prote√≠nas Totales', unit: 'g/dL', keywords: ['proteinas totales', 'prote√≠nas totales'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 6.4 - 8.3 g/dL.' };
                    if (v >= 6.4 && v <= 8.3) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'La cantidad de "ladrillos" (prote√≠nas) en tu sangre es adecuada. Esto sugiere que tu ingesta nutricional es buena y que tu h√≠gado (la "f√°brica de ladrillos") y tus ri√±ones (el "sistema de reciclaje") funcionan correctamente.', advice: 'Tu estado proteico es normal. Es una buena se√±al de nutrici√≥n y funci√≥n hep√°tica y renal adecuadas. ¬°Sigue comiendo una dieta balanceada!' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Valores fuera de rango son una pista. Si est√°n bajos, puede que no est√©s comiendo suficientes prote√≠nas o que tu h√≠gado no las est√© produciendo bien. Si est√°n altos, podr√≠a ser un signo de deshidrataci√≥n (menos "agua" para los mismos "ladrillos") o de inflamaci√≥n cr√≥nica.', advice: `Un valor fuera de rango debe ser interpretado por tu m√©dico, ya que puede estar relacionado con tu dieta, hidrataci√≥n (${HYDRATION_ADVICE.toLowerCase()}), o la funci√≥n de tu h√≠gado y ri√±ones.`, question: `Mis prote√≠nas totales est√°n en ${v}. ¬øPodr√≠a esto estar relacionado con mi dieta o deber√≠amos investigar la funci√≥n de mi h√≠gado/ri√±ones?` };
                }
            },
            ast: {
                label: 'Transaminasa GOT/AST', unit: 'U/L', keywords: ['transaminasa got/ast', 'ast', 'got'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 0 - 38 U/L.' };
                    if (v < 38) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tus niveles de AST son normales. Esto es como confirmar que las "alarmas de incendio" de tu h√≠gado y coraz√≥n est√°n en silencio, lo que sugiere que no hay un da√±o celular significativo en este momento.', advice: '¬°H√≠gado feliz! Un nivel normal de AST es una excelente se√±al de salud hep√°tica. Consejo: Para mantenerlo as√≠, modera el consumo de alcohol y evita los alimentos ultra-procesados.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Niveles elevados indican que las c√©lulas del h√≠gado (o en menor medida, del coraz√≥n o m√∫sculos) est√°n "rotas" y liberando su contenido a la sangre. Es una se√±al clara de estr√©s o da√±o celular que necesita ser investigada. El consumo de alcohol y el h√≠gado graso son causas comunes.', advice: '¬°Alarma en el h√≠gado! Un nivel elevado indica da√±o celular. Es crucial identificar la causa con tu m√©dico. Las m√°s comunes son el alcohol, el h√≠gado graso (por exceso de az√∫car) y algunos medicamentos.', question: `Mi nivel de AST/GOT est√° elevado en ${v}. ¬øDeber√≠amos revisar tambi√©n mi GGT y mi ALT para tener una visi√≥n m√°s completa de la salud de mi h√≠gado?` };
                }
            },
            ldh: {
                label: 'Deshidrogenasa L√°ctica (LDH)', unit: 'U/L', keywords: ['deshidrogenasa lactica', 'ldh'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 200 - 450 U/L.' };
                    if (v >= 200 && v <= 450) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tus niveles de LDH est√°n dentro del rango esperado. La "luz de check engine" de tu cuerpo est√° apagada, lo que no sugiere un da√±o tisular generalizado o estr√©s celular importante.', advice: 'Sin se√±ales de alarma. Un LDH normal es bueno, ya que descarta un da√±o celular masivo en el cuerpo.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Un nivel elevado es un indicador inespec√≠fico de da√±o celular en alguna parte. Puede ser algo benigno como una sesi√≥n de ejercicio muy intensa que caus√≥ da√±o muscular, o puede se√±alar condiciones como anemia hemol√≠tica (destrucci√≥n de gl√≥bulos rojos) o problemas hep√°ticos.', advice: 'La "luz de check engine" de tu cuerpo est√° encendida. Un LDH alto indica da√±o en alg√∫n tejido, pero no dice d√≥nde. Tu m√©dico necesitar√° m√°s pruebas para encontrar el origen.', question: `Mi LDH est√° en ${v}. ¬øHe realizado ejercicio intenso recientemente o deber√≠amos investigar otras posibles fuentes de da√±o celular?` };
                }
            },
            alkalinePhosphatase: {
                label: 'Fosfatasa Alcalina', unit: 'U/L', keywords: ['fosfatasa alcalina'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 80 - 306 U/L.' };
                    if (v >= 80 && v <= 306) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tus niveles son normales, lo que sugiere que el sistema de "tuber√≠as" de tu h√≠gado (v√≠as biliares) fluye sin problemas y que el proceso de "construcci√≥n y demolici√≥n" de tus huesos est√° en equilibrio.', advice: 'Buen funcionamiento de h√≠gado y huesos. Un resultado normal aqu√≠ es una gran noticia para la salud de tus v√≠as biliares y tu metabolismo √≥seo.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Niveles elevados pueden indicar que hay una "obstrucci√≥n" en las v√≠as biliares del h√≠gado, o una actividad √≥sea elevada (com√∫n en adolescentes en crecimiento, fracturas en recuperaci√≥n, o enfermedades √≥seas).', advice: 'Un valor elevado apunta al h√≠gado o a los huesos. Tu m√©dico probablemente pedir√° un examen llamado GGT para diferenciar si el problema es hep√°tico.', question: `Mi fosfatasa alcalina est√° en ${v}. ¬øDeber√≠amos investigar la salud de mi h√≠gado y v√≠as biliares con una GGT, o la de mis huesos?` };
                }
            },
            phosphorus: {
                label: 'F√≥sforo', unit: 'mg/dL', keywords: ['fosforo'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 2.5 - 4.5 mg/dL.' };
                    if (v >= 2.5 && v <= 4.5) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tus niveles de f√≥sforo est√°n bien regulados. Esto es crucial, ya que el f√≥sforo y el calcio trabajan en un delicado equilibrio, gestionado por tus ri√±ones y la hormona paratiroidea (PTH), para mantener tus huesos fuertes y tus c√©lulas con energ√≠a.', advice: '¬°Equilibrio mineral correcto! Un f√≥sforo normal es vital para la salud de tus huesos y la producci√≥n de energ√≠a. Buena se√±al de que tus ri√±ones est√°n haciendo bien su trabajo.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Valores anormales casi siempre apuntan a un problema en el sistema de regulaci√≥n. Un nivel alto es una se√±al de alerta para la funci√≥n renal, ya que los ri√±ones enfermos no pueden eliminarlo. Un nivel bajo puede deberse a problemas de absorci√≥n o a una hiperactividad de la gl√°ndula paratiroides.', advice: 'Un desequilibrio en el f√≥sforo casi siempre apunta a la funci√≥n renal o a la regulaci√≥n hormonal. Es un marcador que tu m√©dico tomar√° muy en serio.', question: `Mis niveles de f√≥sforo est√°n en ${v}. ¬øC√≥mo se correlaciona esto con mi funci√≥n renal y mis niveles de calcio y PTH?` };
                }
            },
            calcium: {
                label: 'Calcio', unit: 'mg/dL', keywords: ['calcio'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 8.5 - 10.5 mg/dL.' };
                    if (v >= 8.5 && v <= 10.5) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tus niveles de calcio en sangre est√°n en un rango saludable. El cuerpo regula este nivel de forma muy estricta, incluso si tiene que "robar" calcio de los huesos para mantenerlo estable. Por lo tanto, un valor normal no siempre significa que tus huesos est√©n bien, pero s√≠ que el sistema de regulaci√≥n inmediata funciona.', advice: 'Nivel de calcio en sangre estable. Consejo: Para proteger tus reservas de calcio en los huesos, aseg√∫rate de consumir suficiente calcio y vitamina D en tu dieta.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Valores fuera de este estrecho rango son una se√±al importante. Suelen indicar problemas con las gl√°ndulas paratiroides (el "termostato" del calcio) o con los niveles de vitamina D (la "llave" que permite absorber el calcio). La funci√≥n renal tambi√©n es crucial.', advice: 'Un valor fuera de este estricto rango es una se√±al de alerta. Tu m√©dico querr√° investigar tus gl√°ndulas paratiroides y tus niveles de vitamina D.', question: `Mis niveles de calcio est√°n en ${v}. ¬øDeber√≠amos evaluar mis niveles de vitamina D y la hormona paratiroidea (PTH)?` };
                }
            },
            bun: {
                label: 'Nitr√≥geno Ureico (BUN)', unit: 'mg/dL', keywords: ['nitrogeno ureico', 'bun'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 0 - 20 mg/dL.' };
                    if (v > 7 && v < 20) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tus ri√±ones parecen estar manejando bien los desechos de prote√≠nas y tu estado de hidrataci√≥n es probablemente adecuado. Es un buen indicador de equilibrio.', advice: `Buena se√±al de funci√≥n renal e hidrataci√≥n. Consejo: Mantenerse bien hidratado y no excederse en el consumo de prote√≠nas ayuda a mantener este valor en rango. ${HYDRATION_ADVICE}` };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Un valor elevado puede tener dos causas principales: deshidrataci√≥n (la "basura" est√° m√°s concentrada en menos "agua") o una disminuci√≥n de la funci√≥n renal (los "filtros" no est√°n limpiando bien). Un valor muy bajo es menos com√∫n, pero puede estar relacionado con una dieta muy baja en prote√≠nas o enfermedad hep√°tica severa.', advice: `Un BUN elevado suele ser un llamado a beber m√°s agua. ${HYDRATION_ADVICE} Si tras hidratarte bien el valor sigue alto, tu m√©dico querr√° evaluar tu funci√≥n renal m√°s a fondo.`, question: `Mi BUN est√° en ${v}. ¬øPodr√≠a estar relacionado con mi hidrataci√≥n o deber√≠amos revisar mi creatinina para confirmar la funci√≥n renal?` };
                }
            },
            urea: {
                label: 'Uremia', unit: 'mg/dL', keywords: ['uremia', 'urea'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 10 - 50 mg/dL.' };
                    if (v >= 10 && v <= 50) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'La eliminaci√≥n de los "residuos" del metabolismo de las prote√≠nas por parte de tus ri√±ones es adecuada. Tu sistema de "limpieza" funciona eficientemente.', advice: '¬°Filtros renales funcionando bien! Un nivel normal de urea es una confirmaci√≥n de que tus ri√±ones est√°n eliminando los desechos de forma eficiente.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Niveles elevados son un fuerte indicador de que los "filtros" de tus ri√±ones no est√°n funcionando a plena capacidad. Aunque tambi√©n puede elevarse por una dieta muy alta en prote√≠nas o deshidrataci√≥n, es un marcador m√°s espec√≠fico de la funci√≥n renal que el BUN.', advice: 'Un nivel de urea elevado es una se√±al de alerta para la funci√≥n renal. Es importante que tu m√©dico lo eval√∫e junto con tu creatinina.', question: `Mi uremia est√° en ${v}. Junto con la creatinina, ¬øqu√© nos dice esto sobre la salud a largo plazo de mis ri√±ones?` };
                }
            },
            totalBilirubin: {
                label: 'Bilirrubina Total', unit: 'mg/dL', keywords: ['bilirrubina total'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 0.1 - 1.0 mg/dL.' };
                    if (v >= 0.1 && v <= 1.0) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tu h√≠gado est√° procesando y eliminando eficientemente los "residuos" del reciclaje de gl√≥bulos rojos. Es una buena se√±al de la capacidad de desintoxicaci√≥n de tu h√≠gado.', advice: 'Tu sistema de reciclaje de gl√≥bulos rojos y tu h√≠gado funcionan bien. Un nivel normal es una gran noticia.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Niveles elevados pueden indicar que el h√≠gado est√° "sobrecargado" o da√±ado, o que hay una "obstrucci√≥n en la tuber√≠a" de las v√≠as biliares. Tambi√©n puede elevarse si hay una destrucci√≥n acelerada de gl√≥bulos rojos (hem√≥lisis). Una condici√≥n gen√©tica benigna llamada S√≠ndrome de Gilbert tambi√©n es una causa com√∫n.', advice: 'Un nivel elevado necesita atenci√≥n m√©dica para determinar si el problema est√° en el h√≠gado, en las v√≠as biliares o en la sangre. Una causa com√∫n y benigna es el S√≠ndrome de Gilbert.', question: `Mi bilirrubina est√° en ${v}. ¬øDeber√≠amos investigar m√°s a fondo la salud de mi h√≠gado o la posibilidad de un problema con mis gl√≥bulos rojos?` };
                }
            },
            albumin: {
                label: 'Alb√∫mina', unit: 'g/dL', keywords: ['albumina'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 3.5 - 5.0 g/dL.' };
                    if (v >= 3.5 && v <= 5.0) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tu h√≠gado est√° produciendo una cantidad adecuada de esta prote√≠na vital. Esto indica una buena funci√≥n hep√°tica y un estado nutricional s√≥lido. <strong>La alb√∫mina act√∫a como un "im√°n" para el agua,</strong> manteniendo la presi√≥n osm√≥tica y evitando que el l√≠quido se escape de los vasos sangu√≠neos.', advice: '¬°Excelente! Un buen nivel de alb√∫mina refleja una buena nutrici√≥n y un h√≠gado sano. Es una de las mejores se√±ales de salud general.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Niveles bajos son una se√±al importante. Pueden indicar que el h√≠gado (la "f√°brica") no la est√° produciendo bien, que los ri√±ones (el "desag√ºe") la est√°n perdiendo, o que no est√°s consumiendo suficientes "materias primas" (prote√≠nas) en tu dieta.', advice: 'Un nivel bajo es una se√±al de alerta importante. Puede indicar problemas con el h√≠gado, los ri√±ones o tu estado nutricional. Tu m√©dico querr√° investigar la causa.', question: `Mis niveles de alb√∫mina est√°n en ${v}. ¬øRefleja esto mi estado nutricional, la salud de mi h√≠gado o la de mis ri√±ones?` };
                }
            },
            agRatio: {
                label: '√çndice A/G', unit: '', keywords: ['indice a/g', '√≠ndice a/g'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 1.2 - 2.2' };
                    if (v >= 1.2 && v <= 2.2) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'El balance entre tus prote√≠nas de "transporte y mantenimiento" (Alb√∫mina) y las de "defensa e inflamaci√≥n" (Globulinas) es adecuado. Es una se√±al de equilibrio general.', advice: 'Un buen equilibrio entre los diferentes tipos de prote√≠nas en tu sangre. Es una se√±al de bajo estado inflamatorio y buena salud general.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Un ratio bajo suele ocurrir cuando la alb√∫mina es baja o las globulinas son altas, lo que puede sugerir inflamaci√≥n cr√≥nica o enfermedades autoinmunes. Un ratio alto es menos com√∫n y puede indicar una producci√≥n deficiente de anticuerpos.', advice: 'Un desequilibrio en este ratio puede ser un signo de inflamaci√≥n cr√≥nica o problemas del sistema inmune. Es una pista que tu m√©dico usar√° para investigar m√°s a fondo.', question: `Mi √≠ndice A/G est√° en ${v}. ¬øQu√© nos dice este desequilibrio sobre mi estado inflamatorio o la producci√≥n de prote√≠nas?` };
                }
            },
            globulins: {
                label: 'Globulinas', unit: 'g/dL', keywords: ['globulinas'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango: 1.5 - 3.5 g/dL' };
                    if (v >= 1.5 && v <= 3.5) return { ...interpretation, tag: { text: 'NORMAL', color: 'bg-green-500' }, physiological: 'Tus niveles de globulinas son normales. Esto sugiere que tu sistema inmunitario no est√° "hiperactivo" ni "debilitado", y que tu estado inflamatorio general est√° en calma.', advice: 'Tu sistema inmune parece estar en equilibrio. Un nivel normal de globulinas es una buena se√±al de que no hay infecciones o inflamaciones cr√≥nicas activas.' };
                    return { ...interpretation, tag: { text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500' }, physiological: 'Niveles alterados son una pista sobre la actividad inmunitaria. Niveles altos pueden indicar una infecci√≥n cr√≥nica o una enfermedad inflamatoria/autoinmune (tu cuerpo est√° produciendo muchos "soldados"). Niveles bajos son menos comunes pero pueden se√±alar problemas gen√©ticos o condiciones que afectan al sistema inmune.', advice: 'Un nivel alterado puede ser una se√±al de inflamaci√≥n o actividad del sistema inmune. Tu m√©dico investigar√° la causa.', question: `Mis niveles de globulinas est√°n en ${v}. ¬øPodr√≠a esto indicar alg√∫n proceso inflamatorio o infeccioso cr√≥nico?` };
                }
            },
            creatinine: { 
                label: 'Creatinina', unit: 'mg/dL', keywords: ['creatinina'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango normal: 0.7-1.3 mg/dL.' };
                    if (v >= 0.7 && v <= 1.3) return { ...interpretation, tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: 'Un nivel normal indica que tus ri√±ones est√°n "filtrando la basura" de la sangre de manera eficiente. La creatinina es un marcador muy fiable porque se produce y se elimina a un ritmo bastante constante.', advice: `¬°Excelente funci√≥n renal! Este es uno de los mejores indicadores de que tus ri√±ones est√°n sanos. Consejo: Mantente bien hidratado y controla tu presi√≥n arterial para protegerlos a largo plazo. ${HYDRATION_ADVICE}` };
                    return { ...interpretation, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Un valor elevado es una se√±al de alerta para la funci√≥n renal; significa que los "filtros" est√°n atascados y no pueden eliminar los desechos. Es importante notar que tambi√©n puede ser m√°s alto en personas con mucha masa muscular (m√°s "desgaste" muscular normal) y m√°s bajo en personas mayores con poca masa muscular.', advice: 'Un nivel elevado es una se√±al de alerta para tus ri√±ones. Es crucial que un m√©dico eval√∫e tu tasa de filtraci√≥n glomerular para determinar la salud renal.', question: 'Mi nivel de creatinina est√° fuera de rango. ¬øC√≥mo se ve este valor en el contexto de mi masa muscular y qu√© nos dice sobre la tasa de filtraci√≥n de mis ri√±ones?' };
                }
            },
            tsh: { 
                label: 'TSH', unit: 'uUI/mL', keywords: ['tsh', 'tiroestimulante'], type: 'numeric',
                interpret: (v) => {
                    let interpretation = { conventional: 'Rango de laboratorio: 0.4 - 4.5 uUI/mL.' };
                    if (v > 0.5 && v < 2.5) return { ...interpretation, tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: 'Este es el rango funcional √≥ptimo. <strong>Imagina que el cerebro es el jefe y la tiroides el trabajador.</strong> Un TSH en este rango significa que el jefe est√° hablando en un tono de voz normal, y el trabajador est√° respondiendo eficientemente. Tu metabolismo est√° bien regulado.', advice: '¬°Comunicaci√≥n perfecta! Un TSH en el rango √≥ptimo indica que la comunicaci√≥n entre tu cerebro y tu tiroides es excelente. Tu metabolismo te lo agradece.' };
                    return { ...interpretation, tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Fuera del rango funcional es una se√±al. Un TSH alto (>2.5) significa que el cerebro est√° "gritando" porque la tiroides est√° "floja" y no responde (hipotiroidismo subcl√≠nico o cl√≠nico). Un TSH bajo (<0.5) significa que la tiroides est√° trabajando demasiado y el cerebro le pide que "se calme" (hipertiroidismo).', advice: 'Un TSH fuera del rango √≥ptimo, incluso si est√° "normal" para el laboratorio, merece atenci√≥n. Un valor alto sugiere hipotiroidismo y uno bajo, hipertiroidismo. Habla con tu m√©dico sobre un panel tiroideo completo.', question: `Mi TSH est√° en ${v}. Aunque est√© en el rango convencional, est√° fuera del √≥ptimo funcional. ¬øDeber√≠amos medir tambi√©n T4 Libre y T3 Libre para ver qu√© est√° haciendo realmente la tiroides?` };
                }
            },
        };
       
        const appState = {
            userProfile: { name: null, dob: null, age: null, sex: null, diet: null },
            labResults: [],
            doctorQuestions: [],
            currentReportIsText: false,
            currentReportText: ''
        };

        const screens = document.querySelectorAll('.screen');
        const manualForm = document.getElementById('manual-form');
        const fileInput = document.getElementById('file-input');
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalLoader = document.getElementById('modal-loader');
        const followUpModal = document.getElementById('follow-up-modal');
        const followUpBtn = document.getElementById('follow-up-btn');
        const followUpCancelBtn = document.getElementById('follow-up-cancel-btn');
        const followUpSubmitBtn = document.getElementById('follow-up-submit-btn');
        const followUpInput = document.getElementById('follow-up-input');
        const masterAdviceBtn = document.getElementById('master-advice-btn');
        const modalDownloadBtn = document.getElementById('modal-download-btn');
        const scanInput = document.getElementById('scan-input');

        function showScreen(screenId) {
            if (screenId === 'dashboard-screen') {
                updateQuestionsList();
            }
            screens.forEach(s => s.classList.add('hidden'));
            const screenToShow = document.getElementById(screenId);
            if(screenToShow) {
                 setTimeout(() => screenToShow.classList.remove('hidden'), 50);
            }
        }
        
        function showModal(title, message, showCloseButton = true, adviceText = null) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modalLoader.classList.add('hidden');
            
            modalCloseBtn.style.display = showCloseButton ? 'block' : 'none';

            if (adviceText) {
                modalDownloadBtn.classList.remove('hidden');
                modalCloseBtn.classList.remove('w-full', 'brand-gradient-bg');
                modalCloseBtn.classList.add('w-1/2', 'bg-white/10');
                modalDownloadBtn.classList.add('w-1/2');

                const newDownloadBtn = modalDownloadBtn.cloneNode(true);
                modalDownloadBtn.parentNode.replaceChild(newDownloadBtn, modalDownloadBtn);
                
                newDownloadBtn.addEventListener('click', () => {
                    downloadAdviceAsPdf(title, adviceText);
                });

            } else {
                modalDownloadBtn.classList.add('hidden');
                modalCloseBtn.classList.add('w-full', 'brand-gradient-bg');
                modalCloseBtn.classList.remove('w-1/2', 'bg-white/10');
                modalDownloadBtn.classList.remove('w-1/2');
            }

            customModal.classList.remove('hidden');
        }

        function downloadAdviceAsPdf(title, advice) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;
            doc.setFontSize(20);
            doc.text(title, 105, y, { align: 'center' });
            y += 10;
            doc.setFontSize(12);
            doc.text(`Para: ${appState.userProfile.name || 'Usuario'}`, 20, y);
            y += 15;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const cleanAdvice = advice.replace(/\*\*(.*?)\*\*/g, '$1');
            let adviceLines = doc.splitTextToSize(cleanAdvice, 170);
            doc.text(adviceLines, 20, y);

            doc.save("ConsejoProfesional.pdf");
        }


        function showLoadingModal(message = "Analizando tu examen...") {
            modalTitle.textContent = "Procesando...";
            modalMessage.textContent = message;
            modalLoader.classList.remove('hidden');
            modalCloseBtn.style.display = 'none';
            customModal.classList.remove('hidden');
        }

        function hideModal() {
            customModal.classList.add('hidden');
        }

        modalCloseBtn.addEventListener('click', hideModal);

        function buildManualForm() {
            let formHTML = '';
            const orderedKeys = Object.keys(BIOMARKERS_DB).sort((a, b) => {
                const aLabel = BIOMARKERS_DB[a].label.toLowerCase();
                const bLabel = BIOMARKERS_DB[b].label.toLowerCase();
                if (aLabel < bLabel) return -1;
                if (aLabel > bLabel) return 1;
                return 0;
            });

            for (const key of orderedKeys) {
                const b = BIOMARKERS_DB[key];
                const inputType = b.type === 'numeric' ? 'number' : 'text';
                const step = inputType === 'number' ? 'step="any"' : '';
                formHTML += `
                    <div>
                        <label for="${key}" class="block text-sm font-medium text-gray-300 mb-1">${b.label} (${b.unit || 'texto'})</label>
                        <input type="${inputType}" ${step} id="${key}" name="${key}" class="w-full custom-input text-xl font-bold brand-gradient-text text-center" placeholder="--">
                    </div>
                `;
            }
            formHTML += `
                <button type="submit" class="w-full brand-gradient-bg text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-indigo-500/40 hover:scale-105 transform transition-transform duration-300 mt-4">
                    Interpretar mis resultados
                </button>
            `;
            manualForm.innerHTML = formHTML;
        }

        document.getElementById('accept-pact-btn').addEventListener('click', () => showScreen('profile-screen'));
        document.getElementById('add-exam-file-btn').addEventListener('click', () => fileInput.click());
        document.getElementById('scan-document-btn').addEventListener('click', () => scanInput.click());

        document.getElementById('add-exam-manual-btn').addEventListener('click', () => showScreen('manual-entry-screen'));
        document.getElementById('back-to-dashboard-from-manual-btn').addEventListener('click', () => showScreen('dashboard-screen'));
        document.getElementById('back-to-dashboard-from-report-btn').addEventListener('click', () => showScreen('dashboard-screen'));

        followUpBtn.addEventListener('click', () => {
            if (appState.currentReportIsText) {
                followUpInput.value = '';
                followUpModal.classList.remove('hidden');
            } else {
                showModal('Funci√≥n no disponible', 'Las preguntas de seguimiento solo est√°n disponibles para informes de texto interpretados por la IA.');
            }
        });

        followUpCancelBtn.addEventListener('click', () => {
            followUpModal.classList.add('hidden');
        });

        followUpSubmitBtn.addEventListener('click', async () => {
            const userQuestion = followUpInput.value.trim();
            if (!userQuestion) {
                showModal('Pregunta vac√≠a', 'Por favor, escribe una pregunta.');
                return;
            }

            followUpModal.classList.add('hidden');
            showLoadingModal("Consultando al asistente...");

            try {
                const context = appState.currentReportText;
                const followUpPrompt = `Contexto del Informe M√©dico Original:\n\n${context}\n\n---\n\nPregunta del Usuario:\n\n${userQuestion}`;
                const followUpSystemPrompt = "Act√∫a como un asistente de IA educativo y amigable. Un usuario te har√° una pregunta sobre su informe m√©dico. El informe original se te da como contexto. Responde a su pregunta de forma muy clara y sencilla, como si se lo explicaras a un amigo o a un familiar, usando analog√≠as si es necesario. Basa tu respuesta S√ìLO en la informaci√≥n del informe. No inventes datos. Mant√©n un tono emp√°tico, NUNCA te presentes como m√©dico y siempre recu√©rdale al final que la √∫ltima palabra la tiene su m√©dico de cabecera.";
                
                const newResponse = await callGeminiAPI(followUpPrompt, followUpSystemPrompt);

                appState.currentReportText += `\n\n---\n\n**Mi Pregunta:** ${userQuestion}\n\n**Respuesta del Asistente:**\n${newResponse}`;
                
                generateTextReport(appState.currentReportText);
                hideModal();

            } catch (error) {
                 console.error("Error al procesar pregunta de seguimiento:", error);
                 showModal('Error', `No se pudo procesar tu pregunta: ${error.message}`);
            }
        });
        
        function formatBiomarkersForPrompt(results) {
            let text = "Resultados del examen de laboratorio:\n";
            for (const key in results) {
                if (Object.prototype.hasOwnProperty.call(results, key)) {
                    const dbEntry = BIOMARKERS_DB[key];
                    if (dbEntry) {
                        text += `- ${dbEntry.label}: ${results[key]} ${dbEntry.unit || ''}\n`;
                    }
                }
            }
            return text;
        }

        masterAdviceBtn.addEventListener('click', async () => {
            showLoadingModal("Consultando al experto...");

            try {
                let context;
                if (appState.currentReportIsText) {
                    context = `Informe m√©dico original:\n${appState.currentReportText}`;
                } else {
                    const lastResults = appState.labResults[appState.labResults.length - 1];
                    context = formatBiomarkersForPrompt(lastResults);
                }

                const masterSystemPrompt = "Act√∫as como un sabio mentor en fisiolog√≠a y bienestar, hablando con alguien que no es experto, puede ser desde un joven hasta un adulto mayor. Basado en el siguiente informe, ofrece un 'Consejo Profesional'. No es un diagn√≥stico, sino una lecci√≥n profunda y educativa que conecte los resultados del informe con un gran principio de la salud. Usa analog√≠as muy claras y sencillas (piensa en cosas de la vida diaria: un auto, una casa, un jard√≠n) y un tono inspirador y cercano. El objetivo es que la persona se vaya con una idea poderosa y aplicable para su vida. La respuesta debe ser concisa, de alto impacto y NUNCA debe sonar como un consejo m√©dico directo.";

                const advice = await callGeminiAPI(context, masterSystemPrompt);

                const formattedAdvice = advice.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>').replace(/\n/g, '<br>');

                showModal("üéì Consejo Profesional", formattedAdvice, true, advice);

            } catch (error) {
                console.error("Error al obtener consejo profesional:", error);
                showModal('Error', `No se pudo generar el consejo: ${error.message}`);
            }
        });


        document.getElementById('profile-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const dob = document.getElementById('dob').value;
            appState.userProfile.name = name;
            appState.userProfile.dob = dob;
            appState.userProfile.sex = document.getElementById('sex').value;
            appState.userProfile.diet = document.getElementById('diet').value;
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            appState.userProfile.age = age;
            document.getElementById('welcome-user').textContent = `Hola ${name}, tienes ${age} a√±os.`;
            showScreen('dashboard-screen');
        });
        
        async function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoadingModal("Analizando el documento...");
            
            try {
                let extractedData = {};
                let fullText = '';

                if (file.type.startsWith('image/')) {
                    const worker = await Tesseract.createWorker('spa');
                    const { data } = await worker.recognize(file, {}, {tessedit_create_hocr: '1'});
                    fullText = data.text;
                    extractedData = parseFromTesseractData(data);
                    await worker.terminate();
                } else if (file.type === 'application/pdf') {
                    const items = await processPdfToStructuredItems(file);
                    fullText = items.map(item => item.str).join(' ');
                    extractedData = parseStructuredItems(items);
                } else {
                     throw new Error("Formato de archivo no compatible.");
                }

                if (Object.keys(extractedData).length > 0) {
                    appState.currentReportIsText = false;
                    appState.labResults.push(extractedData);
                    populateManualForm(extractedData);
                    hideModal();
                    showScreen('manual-entry-screen');
                } else if (fullText.trim().length > 50) {
                    showLoadingModal("No se detectaron biomarcadores, generando un resumen...");
                    const geminiResponse = await callGeminiAPI(fullText);
                    appState.currentReportIsText = true;
                    appState.currentReportText = geminiResponse;
                    generateTextReport(geminiResponse);
                    hideModal();
                    showScreen('report-screen');
                } else {
                    throw new Error("No se pudo extraer texto significativo del documento.");
                }

            } catch (error) {
                console.error("Error al procesar archivo:", error);
                showModal('Error', `Error al procesar archivo: ${error.message}`);
            } finally {
                fileInput.value = '';
                scanInput.value = '';
            }
        }
        
        fileInput.addEventListener('change', handleFile);
        scanInput.addEventListener('change', handleFile);


        manualForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const results = {};
            for (const key in BIOMARKERS_DB) {
                const value = formData.get(key);
                if (value) {
                    results[key] = BIOMARKERS_DB[key].type === 'numeric' ? parseFloat(value.replace(',', '.')) : value.toLowerCase();
                }
            }
            if (Object.keys(results).length > 0) {
                appState.labResults.push(results);
                generateBiomarkerReport(results);
                showScreen('report-screen');
            } else {
                showModal('Sin datos', 'Por favor, introduce al menos un valor para analizar.');
            }
        });
                
        async function callGeminiAPI(text, customSystemPrompt = null) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = customSystemPrompt || "Act√∫a como un int√©rprete de salud y asistente de IA amigable y coloquial. Tu p√∫blico va desde adolescentes a adultos mayores, as√≠ que usa un lenguaje muy simple y cercano, con analog√≠as de la vida cotidiana (ej: 'piensa en tu h√≠gado como el filtro de aceite de un auto'). NO te presentes como un m√©dico. Tu objetivo es 'traducir' informes m√©dicos a un lenguaje comprensible. Divide tu respuesta en tres secciones claras con estos t√≠tulos exactos: '**Hallazgos Principales**', '**Recomendaciones**', y '**Preguntas Clave para tu M√©dico**'. En esta √∫ltima, formula 2 o 3 preguntas que el usuario pueda hacerle a su m√©dico real. S√© emp√°tico y nunca alarmista. El texto que te proporcionar√© es el resultado de un OCR, por lo que puede contener errores; haz tu mejor esfuerzo para interpretarlo.";

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error.message || `Error del servidor: ${response.status}`);
                }
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error en la llamada a la API de Gemini:", error);
                throw new Error(error.message);
            }
        }
        
        async function processPdfToStructuredItems(file) {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    try {
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        const items = [];
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            items.push(...textContent.items);
                        }
                        resolve(items);
                    } catch (error) {
                        reject(error);
                    }
                };
                fileReader.onerror = reject;
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        function parseFromTesseractData(data) {
            const extractedData = {};
            const lines = data.lines;

            for (const key in BIOMARKERS_DB) {
                const b = BIOMARKERS_DB[key];
                let keywordLine = null;
                let keywordWord = null;

                for (const line of lines) {
                    const lineText = line.text.toLowerCase();
                    let hasKeywordInLine = b.keywords.some(k => lineText.includes(k));

                    if (key === 'hcm' && (lineText.includes('c.h.c.m.') || lineText.includes('chcm'))) {
                        hasKeywordInLine = false;
                    }
                    if (key === 'urinalysisLeukocytes' && line.words.some(w => w.text.toLowerCase() === 'sedimento')){
                        hasKeywordInLine = false; 
                    }


                    if (hasKeywordInLine) {
                        keywordLine = line;
                        for(const k of b.keywords){
                            if(lineText.includes(k)){
                                const keywordWords = k.split(' ');
                                const lastKeywordWordText = keywordWords[keywordWords.length - 1];
                                for(const word of line.words){
                                    if(word.text.toLowerCase().includes(lastKeywordWordText)){
                                        keywordWord = word; 
                                    }
                                }
                                break;
                            }
                        }
                        if (keywordWord) break;
                    }
                }


                if (keywordLine && keywordWord) {
                    let bestCandidate = null;
                    let minDistance = Infinity;

                    for (const targetLine of lines) {
                        const verticalDistance = Math.abs(targetLine.bbox.y0 - keywordLine.bbox.y0);
                        
                        if (verticalDistance < 20) { 
                            for (const word of targetLine.words) {
                                const wordTextRaw = word.text.replace(',', '.');
                                const isNumber = /^(\d+(\.\d+)?)$/.test(wordTextRaw);
                                const isRange = /^\d+\s*-\s*\d+$/.test(word.text);
                                const isText = /^[a-z√°√©√≠√≥√∫√±]+$/i.test(word.text);

                                let isCandidate = false;
                                if (b.type === 'numeric' && isNumber) isCandidate = true;
                                if (b.type === 'text' && (isRange || isText || word.text.toLowerCase().includes('negativo'))) isCandidate = true;

                                if (isCandidate) {
                                    if (word.bbox.x0 > keywordWord.bbox.x1) {
                                        const distance = Math.sqrt(Math.pow(word.bbox.x0 - keywordWord.bbox.x1, 2) + Math.pow(word.bbox.y0 - keywordWord.bbox.y0, 2));
                                        
                                        if (distance < minDistance) {
                                            minDistance = distance;
                                            bestCandidate = word.text;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (bestCandidate) {
                        if (b.type === 'numeric') {
                            extractedData[key] = parseFloat(bestCandidate.replace(',', '.'));
                        } else {
                            extractedData[key] = bestCandidate;
                        }
                    }
                }
            }
            return extractedData;
        }
        
        function parseStructuredItems(items) {
            const extractedData = {};
            const cleanItems = items.map(item => ({
                text: item.str.toLowerCase(),
                x: item.transform[4],
                y: item.transform[5]
            }));

            for (const key in BIOMARKERS_DB) {
                const b = BIOMARKERS_DB[key];
                let keywordItem = null;

                for (const k of b.keywords) {
                    keywordItem = cleanItems.find(item => item.text.includes(k));
                    if (keywordItem) break;
                }

                if (key === 'hcm' && cleanItems.some(item => item.text.includes('c.h.c.m') || item.text.includes('chcm'))) {
                   keywordItem = null;
                }
                
                if (keywordItem) {
                    let bestCandidate = null;
                    let minDistance = Infinity;
                    
                    for (const item of cleanItems) {
                         const isNumber = /^(\d+([,.]\d+)?)$/.test(item.text);
                         const isText = /^[a-z√°√©√≠√≥√∫√±]+$/i.test(item.text);

                         let isCandidate = false;
                         if (b.type === 'numeric' && isNumber) isCandidate = true;
                         if (b.type === 'text' && isText) isCandidate = true;

                         if(isCandidate){
                            const dx = item.x - keywordItem.x;
                            const dy = Math.abs(item.y - keywordItem.y);
                            
                            if (dx > 0 && dy < 10) { // To the right and on a similar line
                                if(dx < minDistance){
                                    minDistance = dx;
                                    bestCandidate = item.text;
                                }
                            }
                         }
                    }
                    if (bestCandidate) {
                        if (b.type === 'numeric') {
                            extractedData[key] = parseFloat(bestCandidate.replace(',', '.'));
                        } else {
                            extractedData[key] = bestCandidate;
                        }
                    }
                }
            }
            return extractedData;
        }

        function populateManualForm(data) {
            for (const key in data) {
                const input = document.getElementById(key);
                if (input) {
                    input.value = data[key];
                }
            }
        }
        
        function generateTextReport(text) {
            appState.doctorQuestions = [];
            const questionSectionRegex = /\*\*(Preguntas Clave para tu M√©dico|PARA UNA MEJOR INTERPRETACI√ìN)\*\*([\s\S]*)/i;
            const questionSectionMatch = text.match(questionSectionRegex);
            
            let textForDisplay = text;

            if (questionSectionMatch) {
                const questionSectionText = questionSectionMatch[2];
                const questions = questionSectionText.match(/(\*|\-|\d\.)\s(.*?)(?=\n(\*|\-|\d\.)|$)/g);
                if (questions) {
                    appState.doctorQuestions = questions.map(q => q.replace(/(\*|\-|\d\.)\s/, '').trim());
                }
                textForDisplay = text.replace(questionSectionRegex, '').trim();
            }
            
            const reportContent = document.getElementById('report-content');
            const formattedText = textForDisplay
                .replace(/\*\*(.*?)\*\*/g, '<h3 class="font-bold text-lg mt-4 mb-2 text-indigo-300">$1</h3>')
                .replace(/\n\n---/g, '<hr class="my-4 border-white/10">')
                .replace(/\n\* (.*?)(?=\n\*|\n\n|$)/g, '<p class="pl-4 border-l-2 border-white/20">$1</p>')
                .replace(/\n/g, '<br>'); 
                
            reportContent.innerHTML = `<div class="card p-6 text-gray-300 space-y-3">${formattedText}</div>`;
            
            followUpBtn.style.display = 'block';
        }

        function generateBiomarkerReport(results) {
            const reportContent = document.getElementById('report-content');
            reportContent.innerHTML = '';
            appState.doctorQuestions = [];
            followUpBtn.style.display = 'none';

            let tgHdlRatio = null;
            if (results.triglycerides && results.hdl) {
                tgHdlRatio = (results.triglycerides / results.hdl).toFixed(2);
                let interpretation = {};
                if (tgHdlRatio < 1.5) {
                    interpretation = { tag: {text: '√ìPTIMO', color: 'bg-green-500'}, physiological: 'Excelente indicador de sensibilidad a la insulina y bajo riesgo cardiovascular.', advice: '¬°El mejor indicador de salud metab√≥lica! Un ratio bajo es el resultado de un buen control del az√∫car en sangre. Consejo: Sigue con los h√°bitos que te llevaron a este resultado.' };
                } else {
                    interpretation = { tag: {text: 'REQUIERE ATENCI√ìN', color: 'bg-red-500'}, physiological: 'Fuerte predictor de resistencia a la insulina.', advice: 'Este es uno de los predictores m√°s fuertes de resistencia a la insulina. Para mejorarlo, es crucial reducir los carbohidratos y az√∫cares, y aumentar la actividad f√≠sica.', question: 'Mi ratio TG/HDL es elevado. ¬øQu√© implica esto?' };
                }
                const adviceText = interpretation.advice.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                reportContent.innerHTML += createBiomarkerCard('Ratio TG/HDL', tgHdlRatio, '', interpretation.tag, 'No es un marcador est√°ndar.', interpretation.physiological, 'Este ratio se calcula dividiendo tus Triglic√©ridos entre tu HDL. Es uno de los indicadores m√°s potentes de salud metab√≥lica, incluso m√°s que el LDL por s√≠ solo.', adviceText);
                if (interpretation.question) appState.doctorQuestions.push(interpretation.question);
            }

            for (const key in results) {
                if(Object.prototype.hasOwnProperty.call(results, key)) {
                    const dbEntry = BIOMARKERS_DB[key];
                    if (dbEntry && dbEntry.interpret) {
                        const value = results[key];
                        const interpretation = dbEntry.interpret(value, appState.userProfile.age, appState.userProfile.sex, appState.userProfile.diet, tgHdlRatio);
                        const adviceText = interpretation.advice ? interpretation.advice.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
                        reportContent.innerHTML += createBiomarkerCard(dbEntry.label, value, dbEntry.unit, interpretation.tag, interpretation.conventional, interpretation.physiological, dbEntry.description, adviceText);
                        if (interpretation.question) appState.doctorQuestions.push(interpretation.question);
                    }
                }
            }
            updateQuestionsList();
        }

        function createBiomarkerCard(name, value, unit, tag, conventional, physiological, description, advice) {
            const adviceOnClick = advice ? `onclick="showModal('${name.replace(/'/g, "\\'")}', '${advice}')"` : '';
            const cursorStyle = advice ? 'cursor-pointer hover:scale-110 transition-transform' : '';
            return `
                <div class="card report-card p-5 space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg">${name}</h3>
                            <p class="text-3xl font-black brand-gradient-text">${value} <span class="text-lg text-gray-400">${unit}</span></p>
                        </div>
                        <span class="text-xs font-bold text-white px-3 py-1 rounded-full ${tag.color} ${cursorStyle}" ${adviceOnClick}>${tag.text}</span>
                    </div>
                    <div class="text-sm space-y-3 pt-3 border-t border-white/10">
                        <p><strong class="text-indigo-300">¬øQu√© es este marcador?</strong> <span class="text-gray-400">${description || ''}</span></p>
                        ${conventional ? `<p><strong class="text-gray-300">Interpretaci√≥n Convencional:</strong> <span class="text-gray-400">${conventional}</span></p>` : ''}
                        <p><strong class="text-white">Contexto Fisiol√≥gico:</strong> <span class="text-gray-400">${physiological}</span></p>
                    </div>
                </div>
            `;
        }

        function updateQuestionsList() {
            const list = document.getElementById('questions-list');
            if (appState.doctorQuestions.length > 0) {
                list.innerHTML = appState.doctorQuestions.map(q => `<p class="border-l-2 border-indigo-400 pl-3">${q}</p>`).join('');
            } else {
                list.innerHTML = '<p class="text-gray-500">No se generaron preguntas esta vez.</p>';
            }
        }
        
        document.getElementById('download-pdf-btn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            if(appState.currentReportIsText){
                let y = 15;
                doc.setFontSize(20);
                doc.text("Tu Reporte Fisiol√≥gico", 105, y, { align: 'center' });
                y += 10;
                doc.setFontSize(10);
                let reportLines = doc.splitTextToSize(appState.currentReportText.replace(/<[^>]*>?/gm, ''), 180);
                doc.text(reportLines, 15, y);
            } else {
                const results = appState.labResults[appState.labResults.length - 1];
                let y = 15;
                doc.setFontSize(20);
                doc.text("Tu Reporte Fisiol√≥gico", 105, y, { align: 'center' });
                y += 10;
                doc.setFontSize(12);
                doc.text(`Nombre: ${appState.userProfile.name}`, 20, y);
                y += 7;
                doc.text(`Edad: ${appState.userProfile.age} a√±os`, 20, y);
                doc.text(`Sexo: ${appState.userProfile.sex}`, 105, y, { align: 'center' });
                doc.text(`Dieta: ${appState.userProfile.diet}`, 190, y, { align: 'right' });
                y += 15;
                for (const key in results) {
                    if (y > 270) { doc.addPage(); y = 15; }
                    const dbEntry = BIOMARKERS_DB[key];
                    if (!dbEntry) continue;
                    const value = results[key];
                    const interpretation = dbEntry.interpret(value, appState.userProfile.age, appState.userProfile.sex, appState.userProfile.diet);
                    let displayValue = value;
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${dbEntry.label}: ${displayValue} ${dbEntry.unit || ''}`, 20, y);
                    y += 7;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    let descLines = doc.splitTextToSize(`¬øQu√© es?: ${dbEntry.description}`, 170);
                    doc.text(descLines, 20, y);
                    y += descLines.length * 4 + 2;
                    let physioText = interpretation.physiological.replace(/<[^>]*>?/gm, '');
                    let physioLines = doc.splitTextToSize(`Contexto Fisiol√≥gico: ${physioText}`, 170);
                    doc.text(physioLines, 20, y);
                    y += physioLines.length * 4 + 8;
                }
                if (appState.doctorQuestions.length > 0) {
                     if (y > 250) { doc.addPage(); y = 15; }
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text("Preguntas para tu M√©dico", 20, y);
                    y += 10;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    appState.doctorQuestions.forEach(q => {
                        let qLines = doc.splitTextToSize(`- ${q}`, 170);
                        if (y + qLines.length * 4 > 280) { doc.addPage(); y = 15; }
                        doc.text(qLines, 20, y);
                        y += qLines.length * 4 + 2;
                    });
                }
            }
            doc.save("ReporteFisiologico.pdf");
        });
        
        buildManualForm();
        showScreen('welcome-screen');
    </script>
</body>
</html>

